<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุชุฑุฌู ุฒููุณ</title>
    <link rel="stylesheet" href="style.css"> 

    <link rel="manifest" href="manifest.json">
    
    <meta name="theme-color" content="#002145">
    
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    </head>
<body>
    <div class="container">
        <h1>โก๏ธ ูุชุฑุฌู ุฒููุณ</h1>
        <p>ุงุฎุชุฑ ุงูุฃุฏุงุฉ ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง:</p>
        
        <div class="nav-buttons">
            
            <a href="login.html" class="btn login-btn-main" id="mainLoginBtn">
                <h2 id="loginBtnTitle">๐ ุชุณุฌูู ุงูุฏุฎูู</h2>
                <p id="loginBtnDesc">ูุฑุจุท ุงููุณุฑุฏ ุงูุณุญุงุจู ูุญูุธ ุงูุจูุงูุงุช.</p>
            </a>

            <a href="translator.html" class="btn">
                <h2>ูุชุฑุฌู ูุตู</h2>
                <p>ูุชุฑุฌูุฉ ุงููุตูู ูุฅุฏุงุฑุฉ ููุงุชูุญ API.</p>
            </a>
            
            <a href="ูุญุฑุฑ.html" class="btn">
                <h2>ูุญุฑุฑ ูุตูู</h2>
                <p>ูุชุญุฑูุฑ ุงููุตูู ูุฅุฏุงุฑุฉ ุงููููุงุช ุงููุญููุธุฉ.</p>
            </a>
            
            <a href="glossary_editor.html" class="btn">
                <h2>๐ ูุญุฑุฑ ุงููุณุฑุฏ</h2>
                <p>ูุฅุฏุงุฑุฉ ุงููุตุทูุญุงุช ุงููุฏููุฉ ูุงููุณุชุฎุฑุฌุฉ.</p>
            </a>
            
            <a href="batch_translator.html" class="btn">
                <h2>ุงููุชุฑุฌู ุงูุฌูุงุนู</h2>
                <p>ูุชุฑุฌูุฉ ุงููุตูู ุงููุชุนุฏุฏุฉ.</p>
            </a>

            <a href="batch_extractor.html" class="btn">
                <h2>๐ ุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช ุงูุฌูุงุนู</h2>
                <p>ูุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช ูู ุงููุตูู ุงููุชุฑุฌูุฉ ูุณุจููุง.</p>
            </a>
            <a href="settings.html" class="btn">
                <h2>โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h2>
                <p>ูุชุนุฏูู ุจุฑููุจุช ุงูุชุฑุฌูุฉ ูุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช.</p>
            </a>

            <a href="#" class="btn btn-backup" id="backupBtn">
                <h2>๐ค ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h2>
                <p>ูุญูุธ ูู ุงููุตูู ูุงูุฅุนุฏุงุฏุงุช ูุงูููุงุชูุญ ูู ููู ZIP.</p>
            </a>

            <a href="#" class="btn btn-restore" id="restoreBtn">
                <h2>๐ฅ ุงุณุชุนุงุฏุฉ ูุณุฎุฉ</h2>
                <p>ูุงุณุชุนุงุฏุฉ ุจูุงูุงุชู ูู ููู ZIP (ุณูุชู ุญุฐู ุงูุจูุงูุงุช ุงูุญุงููุฉ).</p>
            </a>
            </div>
    </div>

    <div id="toast" class="toast"></div>
    
    <input type="file" id="restoreInput" accept=".zip" style="display: none;">

    <script src="config.js"></script>
    <script src="jszip.min.js"></script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('ServiceWorker registered: ', registration);
            })
            .catch(registrationError => {
              console.log('ServiceWorker registration failed: ', registrationError);
            });
        });
      }

      // ==== ๐ก (ุฅุถุงูุฉ) ููุฏ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ ุงููุญุฏุซ ููุฏุนู IndexedDB ====

      function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          toast.textContent = message;
          toast.className = 'toast show';
          if (type === 'error') toast.classList.add('error');
          if (type === 'warning') toast.classList.add('warning');

          setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => { toast.className = 'toast'; }, 500);
          }, 4000);
      }

      /**
       * ุฏุงูุฉ ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ (ูุญุฏุซุฉ ูุชููู async)
       */
      async function exportFullBackup() {
          if (typeof JSZip === 'undefined') {
              showToast('ุฎุทุฃ: ููุชุจุฉ (JSZip) ุบูุฑ ููุฌูุฏุฉ.', 'error');
              return;
          }
          
          showToast('ุฌุงุฑู ุชุญุถูุฑ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ... (ูุฏ ูุณุชุบุฑู ููุชุงู)', 'warning');

          try {
              const zip = new JSZip();
              
              // 1. ุฌูุจ ูู ุฃุณูุงุก ุงูููุงุชูุญ ูู CONFIG
              const keysToBackup = Object.values(CONFIG.STORAGE_KEYS);
              
              // 2. ุฅุถุงูุฉ ุงูููุงุชูุญ ุงูุฃุฎุฑู ูุฏููุงู
              keysToBackup.push('zeusEditorConfig'); // ุฅุนุฏุงุฏุงุช ุงููุญุฑุฑ
              keysToBackup.push('zeus_translator_glossary_keys'); // ููุงุชูุญ ูุณุฑุฏ ุงูุชุฑุฌูุฉ ุงูุฌูุงุนูุฉ

              let filesAdded = 0;
              
              // 3. ุงููุฑูุฑ ุนูู ูู ุงูููุงุชูุญ ูุญูุธูุง ูู ุงูู ZIP
              // ููุงุญุธุฉ: ูุณุชุฎุฏู await Storage.get ุจุฏูุงู ูู localStorage.getItem
              for (const key of keysToBackup) {
                  // ูุญุงูู ุฌูุจ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
                  let data = await Storage.get(key);
                  
                  // ุฅุฐุง ูู ูุฌุฏูุง ูู ุงููุงุนุฏุฉ ุงูุฌุฏูุฏุฉุ ูุญุงูู ูู ุงููุฏููุฉ (ุงุญุชูุงุทูุงู ููุฅุนุฏุงุฏุงุช)
                  if (!data) {
                      const localData = localStorage.getItem(key);
                      if (localData) {
                          try { data = JSON.parse(localData); } catch(e) { data = localData; }
                      }
                  }

                  if (data) {
                      // ูุญูุธ ุงูููู ุจููุณ ุงุณู ุงูููุชุงุญ ููุต JSON
                      zip.file(key + ".json", JSON.stringify(data));
                      filesAdded++;
                  }
              }

              if (filesAdded === 0) {
                  showToast('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญูุธูุง!', 'warning');
                  return;
              }

              // 4. ุชูููุฏ ููู ุงูู ZIP
              const zipContent = await zip.generateAsync({ type: "blob" });
              
              // 5. ุฅูุดุงุก ุงุณู ููู ุจุงูุชุงุฑูุฎ
              const date = new Date();
              const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
              const fileName = `ZEUS_Backup_${dateString}.zip`;

              // 6. ุชูุนูู ุงูุชุญููู
              const link = document.createElement('a');
              link.href = URL.createObjectURL(zipContent);
              link.download = fileName;
              document.body.appendChild(link);
              link.click();
              
              setTimeout(() => {
                  document.body.removeChild(link);
                  URL.revokeObjectURL(link.href); 
              }, 100);
              
              showToast(`โ ุชู ุชุตุฏูุฑ ${filesAdded} ูููุงุช ุจูุงูุงุช ุจูุฌุงุญ!`, 'success');

          } catch (err) {
              console.error("ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ:", err);
              showToast('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ููู ZIP.', 'error');
          }
      }

      /**
       * ุฏุงูุฉ ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ (ูุญุฏุซุฉ ูุชููู async ูุชุฏุนู IndexedDB)
       */
      function importFullBackup(event) {
          const file = event.target.files[0];
          if (!file) return;

          if (!confirm("ุชุญุฐูุฑ: ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ (ุงููุตููุ ุงูุฅุนุฏุงุฏุงุชุ ุงูููุงุชูุญ) ูุงุณุชุจุฏุงููุง ุจุงูุจูุงูุงุช ูู ูุฐุง ุงูููู. ูู ุฃูุช ูุชุฃูุฏ ูู ุงููุชุงุจุนุฉุ")) {
              showToast('ุชู ุฅูุบุงุก ุนูููุฉ ุงูุงุณุชุนุงุฏุฉ.', 'warning');
              event.target.value = null; 
              return; 
          }

          showToast('ุฌุงุฑู ูุฑุงุกุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ...', 'warning');
          
          const reader = new FileReader();
          reader.onload = async (e) => {
              try {
                  const content = e.target.result;
                  const zip = await JSZip.loadAsync(content);
                  
                  // ูุณุญ ูู ุดูุก ูู ุงููุงุนุฏุชูู (ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ) ูุถูุงู ูุธุงูุฉ ุงูุงุณุชุนุงุฏุฉ
                  await Storage.clear(); 
                  
                  let filesRestored = 0;

                  // ุงููุฑูุฑ ุนูู ูู ุงููููุงุช ูู ุงูู ZIP
                  for (const filename in zip.files) {
                      if (!zip.files[filename].dir) {
                          const key = filename.replace(".json", "");
                          const fileDataString = await zip.files[filename].async("string");
                          
                          try {
                              const parsedData = JSON.parse(fileDataString);
                              
                              // ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
                              await Storage.set(key, parsedData);
                              
                              // ูููู ุฃูุถูุง ุจุงูุญูุธ ูู localStorage ููุฅุนุฏุงุฏุงุช ุงูุจุณูุทุฉ ููุท ูุถูุงู ุชูุงูู ุงููุญุฑุฑ
                              if(key === 'zeusEditorConfig') {
                                  localStorage.setItem(key, fileDataString);
                              }

                              filesRestored++;
                          } catch (parseErr) {
                              console.error(`ูุดู ุงุณุชุนุงุฏุฉ ${key}`, parseErr);
                          }
                      }
                  }
                  
                  showToast(`โ ุชู ุงุณุชุนุงุฏุฉ ${filesRestored} ููู ุจูุงูุงุช. ูุฑุฌู ุงูุงูุชุธุงุฑ ูุฅุนุงุฏุฉ ุงูุชุญููู...`, 'success');
                  
                  // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุทุจูู ุงูุฅุนุฏุงุฏุงุช
                  setTimeout(() => {
                      window.location.reload();
                  }, 3000);

              } catch (err) {
                  console.error("ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ:", err);
                  showToast('โ ููู ZIP ุชุงูู ุฃู ุบูุฑ ุตุงูุญ.', 'error');
              } finally {
                  event.target.value = null;
              }
          };
          
          reader.onerror = () => {
              showToast('โ ูุดู ูู ูุฑุงุกุฉ ุงูููู.', 'error');
              event.target.value = null;
          };
          
          reader.readAsArrayBuffer(file);
      }

      // --- ุฑุจุท ุงูุฃุญุฏุงุซ ููุฃุฒุฑุงุฑ ุงูุฌุฏูุฏุฉ ---
      document.addEventListener('DOMContentLoaded', () => {
          const backupBtn = document.getElementById('backupBtn');
          const restoreBtn = document.getElementById('restoreBtn');
          const restoreInput = document.getElementById('restoreInput');

          backupBtn.addEventListener('click', (e) => {
              e.preventDefault(); 
              exportFullBackup();
          });

          restoreBtn.addEventListener('click', (e) => {
              e.preventDefault(); 
              restoreInput.click(); 
          });

          restoreInput.addEventListener('change', importFullBackup);

          // === ๐ก ุงูุชุญูู ูู ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู ===
          const token = localStorage.getItem('authToken');
          if (token) {
              const loginBtn = document.getElementById('mainLoginBtn');
              const loginTitle = document.getElementById('loginBtnTitle');
              const loginDesc = document.getElementById('loginBtnDesc');
              
              // ุชุบููุฑ ุดูู ุงูุฒุฑ ููุฏู ุนูู ุฃูู ูุณุฌู ุฏุฎูู
              loginBtn.style.background = 'rgba(0, 255, 136, 0.15)';
              loginBtn.style.borderColor = '#00ff88';
              loginTitle.innerHTML = 'โ ุญุณุงุจู ูุชุตู';
              loginDesc.innerHTML = 'ุงููุฒุงููุฉ ุงูุณุญุงุจูุฉ ููุนูุฉ.';
              
              // (ุงุฎุชูุงุฑู) ุฌุนู ุงูุฒุฑ ุบูุฑ ูุงุจู ููููุฑ ุฃู ููุชุญ ุตูุญุฉ ุงูููู ุงูุดุฎุตู
              loginBtn.href = '#'; 
              loginBtn.style.cursor = 'default';
          }
      });

    </script>
</body>
</html>
