// translator_core.js - ุงููุธุงุฆู ุงูุฃุณุงุณูุฉ ููุชุฑุฌูุฉ


// ====== ุฅุฏุงุฑุฉ ุงููุณุฑุฏ ======

function loadGlossary() {
ย const glossary = Storage.get(CONFIG.STORAGE_KEYS.GLOSSARY);
ย if (!glossary || !glossary.manual_terms || !glossary.extracted_terms) {
ย ย return { manual_terms: {}, extracted_terms: {} };
ย }
ย return glossary;
}

function saveGlossary(glossary) {
ย return Storage.set(CONFIG.STORAGE_KEYS.GLOSSARY, glossary);
}

// ==========================================================
// === (ุจุฏุงูุฉ ุงูุชุนุฏููุงุช ุงูุฌุฐุฑูุฉ ูููุงุนุฏ ุจูุงูุงุช ุงููุตูู) ===
// ==========================================================

// ====== ุฅุฏุงุฑุฉ ุงููุตูู ุงูุฅูุฌููุฒูุฉ ======

function listEnglishChapters() {
ย // ููุฑุฃ ุงูุขู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฅูุฌููุฒูุฉ ุงููุฎุตุตุฉ
ย const chapters = Storage.get(CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS, {});ย
ย return Object.keys(chapters).sort();
}

function readEnglishChapter(filename) {
ย // ููุฑุฃ ุงูุขู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฅูุฌููุฒูุฉ ุงููุฎุตุตุฉ
ย const chapters = Storage.get(CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS, {});
ย // ูุชุฃูุฏ ูู ุฃู ุงูููู ููุฌูุฏ ูุฃู ูู ูุญุชูู
ย if (chapters[filename] && chapters[filename].content) {
ย ย return chapters[filename].content;
ย }
ย return '';
}

function saveEnglishChapter(filename, content) {
ย // ูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฅูุฌููุฒูุฉ ุงููุฎุตุตุฉ
ย const chapters = Storage.get(CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS, {});
ย chapters[filename] = {
ย ย content: content,
ย ย modified: Date.now()
ย };
ย return Storage.set(CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS, chapters);
}

// ====== ุฅุฏุงุฑุฉ ุงููุตูู ุงููุชุฑุฌูุฉ ======

/**
ย* (ุฅุถุงูุฉ ุฌุฏูุฏุฉ)
ย* ูุฐู ูู ุงูุฏุงูุฉ ุงูุชู ูุงูุช ููููุฏุฉ ูุชุณุจุจุช ุจุงูุฎุทุฃ ูู ุงูุตูุฑุฉ
ย*/
function listTranslatedChapters() {
ย // ููุฑุฃ ูู ูุงุนุฏุฉ ุจูุงูุงุช ุงููุตูู ุงููุชุฑุฌูุฉ
ย const chapters = Storage.get(CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS, {});ย
ย return Object.keys(chapters).sort();
}

/**
ย* (ุฅุถุงูุฉ ุฌุฏูุฏุฉ)
ย* ุฏุงูุฉ ูุณุงุนุฏุฉ ููุฑุงุกุฉ ูุตู ูุชุฑุฌู (ุณูุญุชุงุฌูุง ุงููุญุฑุฑ)
ย*/
function readTranslatedChapter(filename) {
ย const chapters = Storage.get(CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS, {});
ย if (chapters[filename] && chapters[filename].content) {
ย ย return chapters[filename].content;
ย }
ย return '';
}

function saveTranslatedChapter(filename, content) {
ย // (ุชู ุงูุชุนุฏูู)
ย // ูุญูุธ ุงูุขู ูู ูุงุนุฏุฉ ุจูุงูุงุช ุงููุตูู ุงููุชุฑุฌูุฉ ุงููุฎุตุตุฉ
ย const chapters = Storage.get(CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS, {});
ยย
ย chapters[filename] = {
ย ย content: content,
ย ย modified: Date.now()
ย };
ยย
ย return Storage.set(CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS, chapters);
}

// ==========================================================
// === (ููุงูุฉ ุชุนุฏููุงุช ููุงุนุฏ ุจูุงูุงุช ุงููุตูู) ===
// ==========================================================


// ====== ุจูุงุก ุงูุจุฑููุจุช ======

function buildGlossaryPrompt(glossary) {
ย const allTerms = {
ย ย ...glossary.manual_terms,
ย ย ...glossary.extracted_terms
ย };

ย if (Object.keys(allTerms).length === 0) {
ย ย return '';
ย }

ย let lines = ['\n๐ ุงุณุชุฎุฏู ูุฐู ุงูุชุฑุฌูุงุช ุฏุงุฆูุงู ูููุตุทูุญุงุช ุงูุชุงููุฉ:'];
ย for (const [en, ar] of Object.entries(allTerms)) {
ย ย lines.push(`- ${en} โ ${ar}`);
ย }

ย return lines.join('\n');
}

function buildTranslationPrompt(text, glossary) {
ย return `
ุฃุฑูุฏู ุฃู ุชุชุฑุฌู ูุฐุง ุงููุตู ุจุฃุณููุจ ุนุฑุจู ูุตูุญ ูุฃุฏุจู ูุชููุ ููุฌุจ ุฃู ูููู ุงูุณุฑุฏ ูุชุตููุง ููุชุฏูููุง ุฏูู ุฃู ุงููุทุงุน ุฃู ุชูุทูุน ูู ุงููุดุงูุฏ. ุฅููู ุงูุชุนูููุงุช:


๐ ููุงุนุฏ ุงูุชูููุฉ ุงูุฏูููุฉ ูุงูุฃุฎูุงููุฉ (ุชูุทุจูู ุชููุงุฆููุง):
ููููุน ุชูุงููุง ุฅุฏุฑุงุฌ ุฃู ุชุฑุฌูุฉ ุฃู ูุญุชูู ุฌูุณู ุฃู ุดุงุฐ ุฃู ููุญู ุจุงููุงุญุดุฉ ุฃู ุฃู ุนุจุงุฑุฉ ุชุชุนุงุฑุถ ูุน ุงูููู ุงูุฅุณูุงููุฉ.
ุนูุฏ ูุฌูุฏ ูุดูุฏ ูู ูุฐุง ุงูููุนุ ุงุญุฐูู ููููุง ุฃู ุงุณุชุจุฏูู ุจุชูููุญ ุนุงู ูุญุชุฑู ูุญุงูุธ ุนูู ุงูุณูุงู ุงููุตุตู ุฏูู ุฎูุถ ูู ุชูุงุตูู ูุญุฑููุฉุ ูุซู:
ุจุฏููุง ูู โูุดูุฏ ุญูููโุ ุชููุชุจ: โุงุจุชุนุฏุช ุงููุงููุฑุง ุนู ุงููุดูุฏ ุชุงุฑูุฉ ูุง ุฌุฑู ุทูู ุงููุชูุงูโ.
ุฃู โุญุฏุซ ูุง ูุง ููุฑููุ ุซู ุชุจุฏูู ูู ุดูุก ุจุนุฏูุง.โ
ููุณูุญ ุจูุฌูุฏ ุงูุนููุ ุงููุชุงูุ ุงูุฏูุงุกุ ุงูุงูุชูุงูุ ุงูุฑุนุจุ ุงููุฃุณุงุฉุ ุงูุธููุ ูุงูุณูุงุฏ ุงูุฏุฑุงูู ููุง ููุ ุฏูู ุฃู ุญุฐู ุฃู ุชูุฐูุจ ูุจุงูุบ ููู.


๐ธ ููููุน ุชูุงููุง:
- ุฅุจูุงุก ุฃู ูููุฉ ุฅูุฌููุฒูุฉ ุญุชู ุงูุฃุณูุงุก ุฃู ุงููุตุทูุญุงุชุ **ุจุงุณุชุซูุงุก ุงูุฃุญุฑู ุงูุฏุงูุฉ ุนูู ุงููุฑุงุชุจ ุฃู ุงููุฆุงุช (Aุ Bุ Cุ Sุ SS...)** ููู ุชุจูู ุจุงูุญุฑูู ุงููุงุชูููุฉ ููุง ูู
- ุงุณุชุฎุฏุงู ููุงุท ุงูุชูุทูุน "..." ุฃู ุงูููุงุตู ุบูุฑ ุงูุณุฑุฏูุฉ
- ูุถุน ุชูุถูุญุงุช ุจุฌุงูุจ ุงูุฃุณูุงุก
- ูุชุงุจุฉ ุงูุชุฑุฌูุฉ ุจุฃุณููุจ ููุทุน ุฃู ูุดูุฏู ูุซู ูุชุงุจุฉ ุงูููุฑุงุช ุงููุตูุฑุฉ ุฃู ุงูุงูุชูุงู ุงูุณุฑูุน ุจูู ุงูุญูุงุฑุงุช ุฏูู ูุตู ุณุฑุฏู
- ุงุณุชุฎุฏุงู ูุฐู ุงูุฑููุฒ <> ุฃู ุฃู ุฑูุฒ ุขุฎุฑ ูู ุงูููุงู ุจูู ุงูุดุฎุตูุงุช ุฃู ุงูุญูุงุฑุงุช
- ุงุณุชุฎุฏุงู ุชูุณููุงุช ูุงุฑูุฏูู ูุงูุบุงูู ูุงููุงุฆู ูุบูุฑูุง
- ุฌุนู ุฃู ููุฑุฉ ุชุญุชูู ุนูู ุฃูุซุฑ ูู 3 ุฅูู 4 ุฌูู ูุชูุณุทุฉ ุงูุทููุ ูุงูููุฑุฉ ุงูุทูููุฉ ุชูุนุชุจุฑ ุฎุทุฃ ูู ุงูุชูุณูู ููุฌุจ ุชูุณูููุง ุฅูู ููุฑุงุช ุฃุฏุจูุฉ ุฃูุตุฑ
- ูุง ุงุฑูุฏ ุงู ูููุฉ ุบูุฑ ูููููุฉ ููุชุฑุงุจุทุฉ ูููุณุช ูู ุงูุณูุงู
- ุชุฑุฌูุฉ ุญุฑููุฉ ุจุชุงุชุงุ ูุง ุงุฑูุฏ ุงู ูููุฉ ุญุฑููุฉ ูุบูุฑ ูููููุฉ ูุบูุฑ ููุงุณุจุฉ ุงูุฑูุงูุฉ ( ููู ุดูุงูุดูุง ููุน ูุญุงูุงุฉ )ย
- ุฑุงุฌุน ุงููุต ูุฑุชูู ูุจู ุชุฑุฌูุฉ ุงู ูุตุทูุญ!

๐ธ ูุทููุจ ุจุดุฏุฉ:
	- ุงุฐุง ูุงูุช ุฑูุงูุฉ ูููู ูุชุงูุ ุตูููุฉุ ูุฌุจ ุนููู ุจุชูููู ุงููุตุทูุญุงุช ูุชูุงุณุจ ุณูุงู ูุตุต ุงููููู ุงููุชุงููุฉ ูุงูุฎูุงู ุงูุตููู (Xianxia) ููุญูุงุธ ุนูู ุฑูุญ ุงููุต ุงูุฃุตูู.
- ุฃู ุชููู ุงูุชุฑุฌูุฉ ุจุฃุณููุจ ุงูุณุฑุฏ ุงููุชุฏูู ุงููุณุชูุฑ ููุง ูู ุงูุฑูุงูุงุช ุงูุนุฑุจูุฉ ุงูููุงุณูููุฉ ุฃู ุงููุตูู ุงูููุญููุฉ
- ุณุฑุฏ ูุชุตู ูุฌุฐุงุจ ุฏูู ุชูุทูุน ุฃู ูุตู ุงููุดุงูุฏ
- ุฅุนุงุฏุฉ ุตูุงุบุฉ ุงูุฌูู ุงูุฑูููุฉ ุฃู ุบูุฑ ุงููููููุฉ ุจูุบุฉ ุฃุฏุจูุฉ ูุงุถุญุฉ
- ุชุทุจูู ุงููุณุฑุฏ ุญุฑูููุง ุนูุฏ ูุฌูุฏ ูุตุทูุญุงุช ููู
- ูุตู ุฌููุน ุงูุฃุณูุงุก ุงูุชู ุชููู ุฃูุซุฑ ูู ููุทุน ูุงุญุฏ
- ุฌุนู ุงูุญูุงุฑุงุช (ุงูููุงู ุจูู ุงูุดุฎุตูุงุช) ุถูู ุนูุงูุงุช ุงูุงูุชุจุงุณ " " ูุงูุชูููุฑ ุถูู ุนูุงูุงุช ' '
- ุชูุณูู ุงูููุฑุงุช ุจุดูู ุฃุฏุจู ูุฑูุญ ููุนููุ ุจุญูุซ ูุง ุชุชุฌุงูุฒ ูู ููุฑุฉ 3 ุฅูู 4 ุฌูู ูุชูุณุทุฉ ุงูุทูู ูุญุฏ ุฃูุตู
- ูุตู ุงูููุฑุงุช ุนูุฏ ุชุบููุฑ ุงููุชุญุฏุซ ุฃู ุชุบููุฑ ุงูุงููุนุงู ุฃู ุงูุชูุงู ุงููุดูุฏ ุงูุฒููู
- ุฌุนู ูู ููุฑุฉ ุชุญูู ููุฑุฉ ุฃู ุฅุญุณุงุณูุง ูุงุญุฏูุง ูุงุถุญูุง ูุน ุงูุญูุงุธ ุนูู ุงูุชุฑุงุจุท ุงูุณุฑุฏู ุงูุนุงู ุฏูู ุชุดุชูุช
- ููุงู ุงููุธุงูุ ูุนุฑููุ ุงูุฐู ููู ุฏููุบ ุงู ูู ุงูุณูุงูุ ุถุนู ุจุฏุงุฎู ูุฐู ุงูููุณูู ููุท []
- ููุงู ุงููุธุงู (ุฏุงุฎู \`[]\`) ูุฌุจ ุฃู ูููู ูู ุณุทุฑ ุฎุงุต ุจู. ุฏูู ุฏูุฌ ููุงู ุงููุธุงู ูู ููุฑุฉ ูุงุญุฏุฉุ ุจูุนููุ ุงุฐุง ูุงู ุงูุซุฑ ูู ููุงู ูููุธุงู ูุซู:ย

[ููุฏ ุฏุฎูุช ุงููุญุงูุงุฉ]ย
(ูุฑุงุบ)
[ุชุฌูุณ ุจุฌูุงุฑ ุงููุงูุฐุฉ ููุณููุง ุจููุฏูู ุจุท ุงููุงูุฏุฑูู ุงููุทุฑุฒ]ย
(ูุฑุงุบ)
["ุงููุนูุฉ! ูุฐุง ุงูุดูุก ูุฌุฏุฏูุงุ" ุชูุนู ุงูููุฏูู ูู ุณุฑู]
(ูุฑุงุบ)
ูุน ูุถุน ูุฑุงุบ ุจูู ูู ููุงู.

๐ธ ุชูุฌููุงุช ุฎุงุตุฉ ุจุงููุตุทูุญุงุช ุงูุฏูููุฉ ูุงูุซูุงููุฉ :

	- ุชุฌูุจ ุงูุฃููุงุธ ุงูุดุฑููุฉ ุงูุตุฑูุญุฉ: ูุฌุจ ุชูููู ุงููุตุทูุญุงุช ุงูุชู ูุฏ ุชุชุนุงุฑุถ ูุน ุงูุนููุฏุฉ ุงูุฅุณูุงููุฉ.
	- ุงูุฃููููุฉ: ุจุฏููุง ูู โุฅููโ (God)ุ ุชูุณุชุฎุฏู ุจุฏุงุฆู ูุซู โุงูุญุงูู ุงููุทููโุ โุงูุณูุฏ ุงูุฃุณููโุ โุงููุงุฆู ุงููุชุนุงููโุ ุฃู โุงูุฎุงูุฏ ุงูุฃุจุฏูโ ููุตู ุงูุดุฎุตูุงุช ูุงุฆูุฉ ุงูููุฉ.
	- ุงูุขููุฉ ุงููุชุนุฏุฏุฉ: ุจุฏููุง ูู โุขููุฉโ (Gods/Deities)ุ ุชูุณุชุฎุฏู ูุตุทูุญุงุช ูุซู โุงูุฃุณูุงุฏ ุงูุณูุงููููโุ โุงููุงุฆูุงุช ุงูุฎุงูุฏุฉโุ ุฃู โุงูุฃุฑูุงุญ ุงูุนููุงโ.
	- ุงูุนุจุงุฏุฉ: ุชููุตู ุงูุฃูุนุงู ูุซู ุงูุฑููุน ุฃู ุงูุณุฌูุฏ ูู โุฅุธูุงุฑ ุงูุฅุฌูุงูโ ุฃู โุงูุงูุญูุงุก ุงุญุชุฑุงููุงโ ุจุฏูุงู ูู โุงูุนุจุงุฏุฉโ ุงููุจุงุดุฑุฉุ ูุง ูู ููู ุงููุนูู ูุง ูุณุชููู ุฅูุง ุจูุง.

๐น ุจุนุฏ ุงูุชุฑุฌูุฉ:
- ุฏููู ุงููุต ูุงูููุง ูุจู ุฅุฎุฑุงุฌู.
- ุชุฃูุฏ ูู ุฃู ุงูููุฑุงุช ูุชูุงุณูุฉ ุจุตุฑููุง ููุชูุงุฑุจุฉ ูู ุงูุทูู ุฏูู ุฅูุฑุงุท ูู ุงููุทุน ุฃู ุงูุญุดู.
- ุฅุฐุง ูุงุญุธุช ุฃู ุจุนุถ ุงูููุฑุงุช ูุตูุฑุฉ ุฌุฏูุง ุฃู ุบูุฑ ููุณูุฉุ ุฃุนุฏ ุฏูุฌูุง ุจูุบุฉ ุฃุฏุจูุฉ ุงูุณูุงุจูุฉ ุญุชู ุชุตู ูุชูุงุฒู ูุซุงูู ุจูู ุงูุฌูุงููุฉ ุงูุจุตุฑูุฉ ูุงูุงูุณูุงุจูุฉ ุงูุณุฑุฏูุฉ.
- ุงููุฏู ุงูููุงุฆู ูู ุชุฑุฌูุฉ ุฃุฏุจูุฉ ูุชููุฉ ููุฑูุญุฉ ูููุฑุงุกุฉุ ุฎุงููุฉ ูู ุงูููุฑุงุช ุงูุทูููุฉ ุงููุฑููุฉ ุฃู ุงููุตูุฑุฉ ุงููุจุชูุฑุฉ.

๐น ุชูุณูู ุฑูู ูุนููุงู ุงููุตู:
- ูุฌุจ ุฃู ูููู ุชูุณูู ุฑูู ูุนููุงู ุงููุตู ูู ุจุฏุงูุฉ ุงููุต ุฏุงุฆููุง ุนูู ุงูุดูู ุงูุขุชู:
ยย
ย ุงููุตู ุงูุณุชูู: ุณููุท ุงูููุฑุฏ ย
ย ____________________________________________

ย (ุณุทุฑ ูุงุฑุบ ููุง)

ย ุซู ูุจุฏุฃ ูุญุชูู ุงููุตู ุจุนุฏ ูุฐุง ุงูุณุทุฑ ุงููุงุฑุบ ูุจุงุดุฑุฉ.

- ุญูุซ ูููุชุจ ุฑูู ุงููุตู ุจุงูุญุฑูู ุงูุนุฑุจูุฉ ุฏุงุฆููุง (ูุซู: ุงููุตู ุงูุนุดุฑููุ ุงููุตู ุงููุฆุฉ ูุฎูุณุฉ ุนุดุฑ...)ุ ุซู ููุทุชุงูุ ุซู ุนููุงู ุงููุตู ููุง ูู ูุชุฑุฌูุ ูุจุนุฏู ุณุทุฑ ูุญุชูู ุนูู ุงูุฎุท ุงูุซุงุจุช ุงูุชุงูู ุชูุงููุง:

ย ____________________________________________

ุชุฑุฌูุฉ ุนููุงู ูุฑูู ุงููุตู ุชูุถุน ููู ูุญุชูู ุงููุตู.

${buildGlossaryPrompt(glossary)}

ุงููุต ุงููุทููุจ ุชุฑุฌูุชู:
"""${text}"""
`;
}

// ====== ุฏูุงู ุงูุชุฑุฌูุฉ ======

async function translateWithGoogle(text) {
ย const url = 'https://translate.googleapis.com/translate_a/single';
ย const params = new URLSearchParams({
ย ย client: 'gtx',
ย ย sl: 'en',
ย ย tl: 'ar',
ย ย dt: 't',
ย ย q: text
ย });

ย try {
ย ย const response = await fetch(`${url}?${params}`, {
ย ย ย method: 'GET',
ย ย ย signal: AbortSignal.timeout(CONFIG.DEFAULT_TIMEOUT * 1000)
ย ย });

ย ย if (response.ok) {
ย ย ย const data = await response.json();
ย ย ย return data[0].map(seg => seg[0]).join('');
ย ย } else {
ย ย ย throw new Error(`ูุดู ุชุฑุฌูุฉ ุฌูุฌู: ${response.status}`);
ย ย }
ย } catch (error) {
ย ย console.error('ุฎุทุฃ ูู ุชุฑุฌูุฉ ุฌูุฌู:', error);
ย ย throw error;
ย }
}

async function translateWithOpenAI(text, glossary, apiKey, model = CONFIG.MODELS.OpenAI) {
ย const prompt = buildTranslationPrompt(text, glossary);
ย const url = 'https://api.openai.com/v1/chat/completions';

ย try {
ย ย const response = await fetch(url, {
ย ย ย method: 'POST',
ย ย ย headers: {
ย ย ย ย 'Authorization': `Bearer ${apiKey}`,
ย ย ย ย 'Content-Type': 'application/json'
ย ย ย },
ย ย ย body: JSON.stringify({
ย ย ย ย model: model,
ย ย ย ย messages: [{ role: 'user', content: prompt }],
ย ย ย ย temperature: 0.7
ย ย ย }),
ย ย ย signal: AbortSignal.timeout(CONFIG.DEFAULT_TIMEOUT * 1000)
ย ย });

ย ย if (response.ok) {
ย ย ย const data = await response.json();
ย ย ย return data.choices[0].message.content;
ย ย } else {
ย ย ย const errorText = await response.text();
ย ย ย throw new Error(`ูุดู ุชุฑุฌูุฉ OpenAI: ${response.status} - ${errorText}`);
ย ย }
ย } catch (error) {
ย ย console.error('ุฎุทุฃ ูู ุชุฑุฌูุฉ OpenAI:', error);
ย ย throw error;
ย }
}

async function translateWithTogether(text, glossary, apiKey, model = CONFIG.MODELS.Together) {
ย const prompt = buildTranslationPrompt(text, glossary);
ย const url = 'https://api.together.xyz/v1/chat/completions';

ย try {
ย ย const response = await fetch(url, {
ย ย ย method: 'POST',
ย ย ย headers: {
ย ย ย ย 'Authorization': `Bearer ${apiKey}`,
ย ย ย ย 'Content-Type': 'application/json'
ย ย ย },
ย ย ย body: JSON.stringify({
ย ย ย ย model: model,
ย ย ย ย messages: [{ role: 'user', content: prompt }],
ย ย ย ย temperature: 0.7
ย ย ย }),
ย ย ย signal: AbortSignal.timeout(CONFIG.DEFAULT_TIMEOUT * 1000)
ย ย });

ย ย if (response.ok) {
ย ย ย const data = await response.json();
ย ย ย return data.choices[0].message.content;
ย ย } else {
ย ย ย const errorText = await response.text();
ย ย ย throw new Error(`ูุดู ุชุฑุฌูุฉ Together: ${response.status} - ${errorText}`);
ย ย }
ย } catch (error) {
ย ย console.error('ุฎุทุฃ ูู ุชุฑุฌูุฉ Together:', error);
ย ย throw error;
ย }
}

async function translateWithGemini(text, glossary, apiKey, model = CONFIG.MODELS.Gemini) {
ย const prompt = buildTranslationPrompt(text, glossary);
ย const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

ย try {
ย ย const response = await fetch(url, {
ย ย ย method: 'POST',
ย ย ย headers: {
ย ย ย ย 'Content-Type': 'application/json'
ย ย ย },
ย ย ย body: JSON.stringify({
ย ย ย ย contents: [{
ย ย ย ย ย parts: [{ text: prompt }]
ย ย ย ย }]
ย ย ย }),
ย ย ย signal: AbortSignal.timeout(CONFIG.DEFAULT_TIMEOUT * 1000)
ย ย });

ย ย if (response.ok) {
ย ย ย const data = await response.json();
ย ย ย return data.candidates[0].content.parts[0].text;
ย ย } else {
ย ย ย const errorText = await response.text();
ย ย ย throw new Error(`ูุดู ุชุฑุฌูุฉ Gemini: ${response.status} - ${errorText}`);
ย ย }
ย } catch (error) {
ย ย console.error('ุฎุทุฃ ูู ุชุฑุฌูุฉ Gemini:', error);
ย ย throw error;
ย }
}

// ====== ุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช ======

async function extractTermsWithGemini(englishText, arabicText, apiKey, currentGlossary) {
ย // ุชู ุชุตุญูุญ ุนูุงูุงุช ุงูุชูุตูุต ูู ูุซุงู JSON
ย const prompt = `
ุฃูุช ูุณุงุนุฏ ุฎุจูุฑ ูู ุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช ูุงูุฃุณูุงุก ูู ุงููุตูุต ุงููุชุฑุฌูุฉ.
ูููุชู ูู ูุฑุงุกุฉ ุงููุต ุงูุฅูุฌููุฒู ูุชุฑุฌูุชู ุงูุนุฑุจูุฉุ ุซู ุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช ุงูุชูููุฉุ ุฃุณูุงุก ุงูุฃุนูุงู (ูุซู ุฃุณูุงุก ุงูุฃุดุฎุงุตุ ุงูุฃูุงููุ ุงูููุธูุงุช)ุ ูุงูููุงููู ุงูุฑุฆูุณูุฉ.

## **ุฑูุฒ ุจุดูู ุฎุงุต ุนูู ุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช ุงูุชู ุชูุฏุฑุฌ ุชุญุช ุงููุฆุงุช ุงูุชุงููุฉ:**

- **ูุตุทูุญุงุช ุงูุฒุฑุงุนุฉ ูุงูุชูููุงุช:** ูุซู ุฃููุงุน ุงููุจุงุชุงุชุ ุฃุณุงููุจ ุงูุฒุฑุงุนุฉุ ุฃุฏูุงุช ูุชูููุงุช ุฒุฑุงุนูุฉุ ุฃูุฑุงุถ ุงููุจุงุชุงุชุ ุญููู ููุฏุณูุฉ ุฒุฑุงุนูุฉ.
- **ุฃุณูุงุก ุงูููุงูุน ูุงูููุฑุงุช:** ุฃุณูุงุก ุงููุฏูุ ุงููุฑูุ ุงูููุงุทู ุงูุฌุบุฑุงููุฉุ ุงููุจุงููุ ุงูููุฑุงุช ุงูุญููููุฉ ุฃู ุงูุฎุงุตุฉุ ุฃู ูููุน ุฐู ุฃูููุฉ.
- **ุงูุดุฎุตูุงุช ูุงูุฑุชุจ ุงูุฎุงูุฏุฉ:** ุฃุณูุงุก ุงูุฃุดุฎุงุตุ ุงูุฃููุงุจุ ุงูุฑุชุจ ุงูุนุณูุฑูุฉ ุฃู ุงูุงุฌุชูุงุนูุฉุ ุงูุดุฎุตูุงุช ุงูุชุงุฑูุฎูุฉ ุฃู ุงูุฎูุงููุฉ.
- **ููุงููู ุฑูุญูุฉ ูุฒุฑุงุนูุฉ:** ุงููุตุทูุญุงุช ุงูุฏูููุฉุ ุงูููุณููุฉุ ุงูุฑูุญูุฉุ ุฃู ุงูููุงููู ุงููุชุนููุฉ ุจุงูุฒุฑุงุนุฉ ุงูุนุถููุฉุ ุงูุงุณุชุฏุงูุฉุ ุงูุชููุน ุงูุจููููุฌู.

**ุงูููุงุนุฏ:**

- ูุฌุจ ุฃู ูููู ูู ูุตุทูุญ ุฅูุฌููุฒู ูุฑูุฏูุง.
- ูุฌุจ ุฃู ุชููู ุงููููุงุช ุงููุณุชุฎุฑุฌุฉ ูุตุทูุญุงุช ุฐุงุช ูุนูู ูู ุณูุงููุง.
- ุชุฌุงูู ุงููููุงุช ุงูุดุงุฆุนุฉ ุฃู ุงูุญุฑูู ุฃู ุงูุฃูุนุงู ุงูุชู ูุง ุชูุซู ูุตุทูุญุงุช.
- ูุฏู ุงููุชุงุฆุฌ ุจุชูุณูู JSON ููุทุ ุญูุซ ูููู ุงูููุชุงุญ ูู ุงููุตุทูุญ ุงูุฅูุฌููุฒู ูุงููููุฉ ูู ุงูุชุฑุฌูุฉ ุงูุนุฑุจูุฉ ุงูููุงุจูุฉ.
- ูุฌุจ ุฃู ุชุชุทุงุจู ุงูุชุฑุฌูุฉ ุงูุนุฑุจูุฉ ุชูุงููุง ูุน ุงููููุฉ ุฃู ุงูุนุจุงุฑุฉ ูู ุงููุต ุงูุนุฑุจู ุงููุนุทู.

ูุซุงู ูุชูุณูู JSON ุงููุทููุจ:
{"Artificial Intelligence": "ุงูุฐูุงุก ุงูุงุตุทูุงุนู", "New York": "ูููููุฑู", "API Key": "ููุชุงุญ API", "Sustainable Agriculture": "ุงูุฒุฑุงุนุฉ ุงููุณุชุฏุงูุฉ"}

ุงููุต ุงูุฅูุฌููุฒู:
"""${englishText}"""

ุงููุต ุงูุนุฑุจู:
"""${arabicText}"""

ุงูุขูุ ูุฏู ุงููุตุทูุญุงุช ุงููุณุชุฎุฑุฌุฉ ุจุชูุณูู JSON:
`;

ย const url = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.MODELS.GeminiFlash}:generateContent?key=${apiKey}`;

ย try {
ย ย const response = await fetch(url, {
ย ย ย method: 'POST',
ย ย ย headers: {
ย ย ย ย 'Content-Type': 'application/json'
ย ย ย },
ย ย ย body: JSON.stringify({
ย ย ย ย contents: [{
ย ย ย ย ย parts: [{ text: prompt }]
ย ย ย ย }]
ย ย ย }),
ย ย ย signal: AbortSignal.timeout(CONFIG.DEFAULT_TIMEOUT * 1000)
ย ย });

ย ย if (!response.ok) {
ย ย ย const errorText = await response.text();
ย ย ย throw new Error(`ูุดู ุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช: ${response.status} - ${errorText}`);
ย ย }

ย ย const data = await response.json();
ย ย let responseContent = data.candidates[0].content.parts[0].text;

ย ย // ุฅุฒุงูุฉ ุชูุณูู markdown ุฅุฐุง ูุฌุฏ
ย ย if (responseContent.startsWith('```json') && responseContent.endsWith('```')) {
ย ย ย responseContent = responseContent.slice(7, -3).trim();
ย ย } else if (responseContent.startsWith('```') && responseContent.endsWith('```')) {
ย ย ย responseContent = responseContent.slice(3, -3).trim();
ย ย }

ย ย const extractedTerms = JSON.parse(responseContent);

ย ย // ุชุตููุฉ ุงููุตุทูุญุงุช ุงูููุฑุฑุฉ
ย ย const allExistingTerms = {
ย ย ย ...currentGlossary.manual_terms,
ย ย ย ...currentGlossary.extracted_terms
ย ย };

ย ย const normalizedExisting = {};
ย ย for (const [en, ar] of Object.entries(allExistingTerms)) {
ย ย ย normalizedExisting[en.toLowerCase()] = ar.toLowerCase();
ย ย }

ย ย const newTerms = {};
ย ย for (const [en, ar] of Object.entries(extractedTerms)) {
ย ย ย const normalizedEn = en.toLowerCase();
ย ย ย const normalizedAr = ar.toLowerCase();

ย ย ย let isDuplicate = false;

ย ย ย // ูุญุต ุงูุชุทุงุจู ุงูุฅูุฌููุฒู
ย ย ย if (normalizedExisting[normalizedEn]) {
ย ย ย ย isDuplicate = true;
ย ย ย } else {
ย ย ย ย // ูุญุต ุงูุชุดุงุจู
ย ย ย ย for (const existingEn of Object.keys(normalizedExisting)) {
ย ย ย ย ย if (normalizedEn.includes(existingEn) || existingEn.includes(normalizedEn)) {
ย ย ย ย ย ย isDuplicate = true;
ย ย ย ย ย ย break;
ย ย ย ย ย }
ย ย ย ย }
ย ย ย }

ย ย ย // ูุญุต ุงูุชุทุงุจู ุงูุนุฑุจู
ย ย ย if (!isDuplicate) {
ย ย ย ย for (const existingAr of Object.values(normalizedExisting)) {
ย ย ย ย ย if (normalizedAr === existingAr ||
ย ย ย ย ย ย normalizedAr.includes(existingAr) ||
ย ย ย ย ย ย existingAr.includes(normalizedAr)) {
ย ย ย ย ย ย isDuplicate = true;
ย ย ย ย ย ย break;
ย ย ย ย ย }
ย ย ย ย }
ย ย ย }

ย ย ย if (!isDuplicate) {
ย ย ย ย newTerms[en] = ar;
ย ย ย }
ย ย }

ย ย // ุชุญุฏูุซ ุงููุณุฑุฏ
ย ย const updatedGlossary = {
ย ย ย ...currentGlossary,
ย ย ย extracted_terms: {
ย ย ย ย ...currentGlossary.extracted_terms,
ย ย ย ย ...newTerms
ย ย ย }
ย ย };

ย ย return { glossary: updatedGlossary, newTerms };

ย } catch (error) {
ย ย console.error('ุฎุทุฃ ูู ุงุณุชุฎุฑุงุฌ ุงููุตุทูุญุงุช:', error);
ย ย throw error;
ย }
}