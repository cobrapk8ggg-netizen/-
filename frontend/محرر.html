<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>ğŸ“– Ù…Ø­Ø±Ø± ZEUS</title>
    
    <script src="jszip.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/dialog/dialog.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cairo:wght@400;700&family=Noto+Kufi+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø¥Ø®ÙØ§Ø¡ Ø£Ø´Ø±Ø·Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø²Ø¹Ø¬Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ==== */
        ::-webkit-scrollbar {
            display: none; /* ÙŠØ®ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù…ØªØµÙØ­ (ÙƒØ±ÙˆÙ…/Ø³ÙØ§Ø±ÙŠ) */
            width: 0;
            height: 0;
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· ØªÙ…Ø±ÙŠØ± CodeMirror Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
        .CodeMirror-vscrollbar, .CodeMirror-hscrollbar {
            display: none !important;
        }
        /* ====================================================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100vh;
            overflow: hidden; 
        }

        body {
            font-family: 'Geeza Pro', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0; 
            overflow: hidden; 
        }

        .editor-container {
            width: 100%;
            max-width: 100%; 
            background: white;
            border-radius: 0; 
            box-shadow: none; 
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%; 
        }

        .editor-container.fullscreen {
            max-width: 100vw;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            padding-top: calc(15px + env(safe-area-inset-top, 0px));
            flex-wrap: wrap; 
            justify-content: center; 
        }

        .header.hidden {
            display: none;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4); 
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px); 
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 8px;
            font-size: 20px;
            flex-shrink: 0; 
        }

        .filename-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.4); 
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            text-align: center;
            backdrop-filter: blur(8px); 
            transition: all 0.3s ease;
            min-width: 150px; 
        }

        .filename-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .filename-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .filename-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef; 
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .controls.hidden {
            display: none;
        }

        .control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-row:last-child {
            margin-bottom: 0;
        }

        .segmented-control {
            display: flex;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            flex: 1;
        }

        .segment {
            flex: 1;
            padding: 10px 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #495057;
        }

        .segment.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .segment:hover:not(.active) {
            background: #dee2e6;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
        }

        .control-btn {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .control-btn.active {
             background: #3a4bb7;
             box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .control-btn.save {
            background: linear-gradient(135deg, #28a745, #218838);
            font-weight: bold;
            font-size: 16px;
        }
        
        .control-row .control-btn.save {
             width: 100%;
        }

        .control-btn.save:hover {
            background: linear-gradient(135deg, #218838, #1e7e34); 
        }

        .text-editor {
            padding: 20px;
            font-size: 18px;
            line-height: 1.5;
            border: none;
            width: 100%;
            resize: none;
            font-family: 'Geeza Pro', 'Arial', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            direction: rtl;
            flex-grow: 1; 
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            overflow-y: auto; 
        }

        /* ==== ğŸ’¡ (ØªØ¹Ø¯ÙŠÙ„) Ø¥ØµÙ„Ø§Ø­ Ø§Ø±ØªÙØ§Ø¹ CodeMirror ==== */
        .CodeMirror {
            flex-grow: 1;
            height: 100% !important; /* ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† auto Ø¥Ù„Ù‰ 100% Ù„Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ */
            font-family: 'Geeza Pro', 'Arial', sans-serif; 
            font-size: 18px; 
            line-height: 1.5; 
            direction: rtl;
        }

        .cm-system-text {
            color: #007bff; 
            font-weight: bold;
        }
        .cm-dialogue-text {
            color: #28a745; 
        }


        .text-editor:focus {
            outline: none;
        }

        .text-editor.read-only {
            cursor: default;
            background-color: #f8f9fa; 
        }

        .stats {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef; 
            color: #6c757d;
            font-size: 12px;
            text-align: right;
            transition: all 0.3s ease;
            flex-shrink: 0;
            padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
        }

        .stats.hidden {
            display: none;
        }
        
        .controls.dark-interface,
        .stats.dark-interface {
            background: #222; 
            color: #f1f1f1; 
            border-color: #333; 
        }
        .controls.dark-interface .segmented-control {
            background: #444;
        }
        .controls.dark-interface .segment {
            color: #f1f1f1; 
        }
        .controls.dark-interface .segment:hover:not(.active) {
            background: #555;
        }


        .exit-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            transition: all 0.3s ease;
            top: calc(20px + env(safe-area-inset-top, 0px));
        }

        .exit-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .exit-btn.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh; 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            display: flex; 
            flex-direction: column; 
            transition: background-color 0.3s, color 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            flex-shrink: 0; 
            transition: border-color 0.3s;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            transition: color 0.3s;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            color: #333;
            transform: rotate(90deg);
        }

        .file-list {
            list-style: none;
            overflow-y: auto; 
            max-height: 35vh; 
            padding-right: 10px; 
            overflow-x: hidden; /* ÙŠÙ…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ */
        }
        
        /* ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) ØªÙ†Ø³ÙŠÙ‚ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ==== */
        .selection-list {
            list-style: none;
            overflow-y: auto;
            max-height: 50vh;
        }
        .selection-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent; 
            font-size: 16px;
        }
        .selection-item:hover {
            background: #dee2e6;
            border-color: #bdc3c7;
        }
        .selection-item.active {
            background: #667eea;
            color: white;
            font-weight: bold;
            border-color: #5568d3;
        }
        .modal-content.dark-interface .selection-item {
            background: #333;
            color: #f1f1f1;
            border-color: #555;
        }
        .modal-content.dark-interface .selection-item:hover {
            background: #555;
            border-color: #777;
        }
        .modal-content.dark-interface .selection-item.active {
            background: #667eea;
            color: white;
            border-color: #5568d3;
        }
        /* Ø®Ø·ÙˆØ· Ù…Ø®ØµØµØ© Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .font-cairo { font-family: 'Cairo', sans-serif; }
        .font-noto-kufi { font-family: 'Noto Kufi Arabic', sans-serif; }
        .font-amiri { font-family: 'Amiri', serif; }
        .font-geeza { font-family: 'Geeza Pro', sans-serif; }
        .font-arial { font-family: 'Arial', sans-serif; }
        .font-times { font-family: 'Times New Roman', serif; }
        /* ============================================== */

        .search-bar {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .search-bar:focus {
             outline: none;
             border-color: #667eea;
        }
         .search-bar::placeholder {
            color: #999;
            transition: color 0.3s;
        }

        .modal-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
            flex-wrap: wrap; 
        }
        .modal-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .modal-btn.select {
            background: #667eea;
            color: white;
        }
        .modal-btn.danger {
            background: #dc3545;
            color: white;
        }
        .modal-btn.danger:hover {
             background: #c82333;
        }
        
        #reverseSortBtn {
            flex: 0 0 50px; 
            background: #e9ecef;
            color: #495057;
            font-size: 18px;
        }
        #reverseSortBtn.active {
            background: #667eea;
            color: white;
        }

        .file-item {
            display: flex; 
            align-items: center;
            gap: 10px; 
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent; 
        }
        .file-item:hover {
            background: #667eea;
            color: white;
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .file-checkbox-container {
            display: none; 
        }
        
        .file-checkbox {
             width: 20px;
             height: 20px;
             cursor: pointer;
        }

        .file-details {
            flex: 1; 
            pointer-events: none; 
        }

        .file-info {
            font-size: 12px;
            color: #6c757d;
            pointer-events: none;
        }

        .file-item:hover .file-info {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .file-list.selection-active .file-checkbox-container {
            display: block; 
        }
        .file-list.selection-active .file-item:hover {
            background: #dee2e6; 
            color: black;
            transform: translateX(0);
            box-shadow: none;
        }
        .file-list.selection-active .file-item:hover .file-info {
            color: #6c757d;
        }
        .file-list.selection-active .file-item.selected {
            background: #cce0ff; 
            color: black;
            border-color: #667eea;
        }
         .file-list.selection-active .file-item.selected .file-info {
             color: #333;
         }

        .color-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .color-item {
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 2px solid transparent;
        }

        .color-item:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-color: #667eea;
        }
        
        .modal-content.dark-interface {
            background: #222;
            color: #f1f1f1;
        }
        .modal-content.dark-interface .modal-header {
            border-color: #444;
        }
        .modal-content.dark-interface .modal-title {
            color: #f1f1f1;
        }
         .modal-content.dark-interface .close-modal {
            color: #888;
        }
        .modal-content.dark-interface .close-modal:hover {
            color: #f1f1f1;
        }
        .modal-content.dark-interface .search-bar {
            background: #333;
            color: #f1f1f1;
            border-color: #555;
        }
        .modal-content.dark-interface .search-bar::placeholder {
            color: #888;
        }
        .modal-content.dark-interface .segmented-control {
            background: #444;
        }
        .modal-content.dark-interface .segment {
            color: #f1f1f1;
        }
        .modal-content.dark-interface .segment:hover:not(.active) {
            background: #555;
        }
         .modal-content.dark-interface #reverseSortBtn {
            background: #444;
            color: #f1f1f1;
        }
        .modal-content.dark-interface #reverseSortBtn.active {
            background: #667eea;
            color: white;
        }
        .modal-content.dark-interface .file-item {
            background: #333;
            color: #f1f1f1;
        }
         .modal-content.dark-interface .file-info {
            color: #888;
        }
        .modal-content.dark-interface .file-item:hover {
            background: #667eea;
            color: white;
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .modal-content.dark-interface .file-item:hover .file-info {
            color: rgba(255, 255, 255, 0.8);
        }
        .modal-content.dark-interface .file-list.selection-active .file-item:hover {
            background: #555;
            color: #f1f1f1;
            transform: translateX(0);
            box-shadow: none;
        }
         .modal-content.dark-interface .file-list.selection-active .file-item:hover .file-info {
            color: #888;
        }
        .modal-content.dark-interface .file-list.selection-active .file-item.selected {
            background: #004080; 
            color: white;
            border-color: #667eea;
        }
         .modal-content.dark-interface .file-list.selection-active .file-item.selected .file-info {
             color: #ddd;
         }
         .modal-content.dark-interface .color-item {
             border: 2px solid #555;
         }
        
        .CodeMirror-dialog {
            background: #333;
            color: #f1f1f1;
            border-color: #555;
        }
        .CodeMirror-dialog input {
            background: #222;
            color: #f1f1f1;
            border: 1px solid #555;
        }

        .modal-content.dark-interface .input-group label {
             color: #ccc;
        }
        .modal-content.dark-interface .input-group input {
            background: #333;
            color: #f1f1f1;
            border-color: #555;
        }


        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .theme-white {
            background: white;
            color: black;
        }

        .theme-dark {
            background: #000000;
            color: white;
        }

        .theme-blue-dark {
            background: #001F3F;
            color: white;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
            }

            .btn-group {
                width: 100%;
                justify-content: center;
            }

            .control-btn {
                flex: 0 1 auto; 
            }
            
            .control-row .control-btn.save {
                 width: auto; 
            }
            
            .header .btn-icon {
                 width: 36px;
                 height: 36px;
                 padding: 6px;
                 font-size: 18px;
            }
            .header .filename-input {
                 padding: 8px 10px;
                 font-size: 14px;
                 min-width: 100px;
            }

            .editor-container {
                 height: 100%; 
                 padding: 0;
                 border-radius: 0;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            animation: slideIn 0.3s ease;
            display: none;
            top: calc(20px + env(safe-area-inset-top, 0px));
        }

        .notification.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid #28a745;
        }

        .notification.error {
            border-left: 4px solid #dc3545;
        }

        .notification.warning {
            border-left: 4px solid #ffc107;
        }

        .sort-control {
            margin-bottom: 15px;
            flex-shrink: 0; 
        }
        
        #importTypeModal .modal-content,
        #exportZipModal .modal-content {
            max-height: 50vh;
        }
        .import-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .import-btn {
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            border: 2px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .import-btn:hover {
            border-color: #667eea;
            background: #cce0ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
         #importTypeModal.dark-interface .modal-content,
         #exportZipModal.dark-interface .modal-content {
            background: #222;
            color: #f1f1f1;
         }
         #importTypeModal.dark-interface .import-btn,
         #exportZipModal.dark-interface .import-btn {
            background: #333;
            border-color: #555;
            color: #f1f1f1;
         }
         #importTypeModal.dark-interface .import-btn:hover,
         #exportZipModal.dark-interface .import-btn:hover {
            background: #004080;
            border-color: #667eea;
         }
    </style>
</head>
<body>

    <div class="editor-container" id="editorContainer">
        <div class="header" id="header">
            <button class="btn btn-icon" id="fullscreenBtn" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">ğŸ”³</button>
            <button class="btn btn-icon" id="openChapterBtn" title="ÙØªØ­ ÙØµÙ„">ğŸ“‚</button>
            <button class="btn btn-icon" id="newChapterBtn" title="ÙØµÙ„ Ø¬Ø¯ÙŠØ¯">â•</button>
            <button class="btn btn-icon" id="importFileBtn" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù">ğŸ“¥</button>
            <button class="btn btn-icon" id="exportZipBtn" title="ØªØµØ¯ÙŠØ± ZIP">ğŸ“¦</button>
            
            <button class="btn btn-icon" id="nextChapterBtn" title="Ø§Ù„ÙØµÙ„ Ø§Ù„ØªØ§Ù„ÙŠ">â¬…ï¸</button>
            <button class="btn btn-icon" id="prevChapterBtn" title="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚">â¡ï¸</button>
            <input type="text" class="filename-input" id="filenameInput" placeholder="Ù„Ù… ÙŠØªÙ… ÙØªØ­ Ù…Ù„Ù" disabled>
            <button class="btn btn-icon" id="bgColorBtn" title="Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©">ğŸ¨</button>
            <button class="btn btn-icon" id="readBtn" title="ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©">ğŸ‘ï¸</button>
            <a href="index.html" class="btn btn-icon" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" style="text-decoration: none;">ğŸ </a>
        </div>

        <div class="controls" id="controls">
            
            <div class="control-row">
                <div class="btn-group">
                    <button class="control-btn" id="increaseFontBtn">A+</button>
                    <button class="control-btn" id="decreaseFontBtn">A-</button>
                    <button class="control-btn" id="spacingBtn">â¤´ï¸ ØªØ¨Ø§Ø¹Ø¯</button>
                    <button class="control-btn" id="fontSelectBtn">âœï¸ Ø§Ù„Ø®Ø·</button>
                    <button class="control-btn" id="themeSelectBtn">ğŸ¨ Ø§Ù„Ø«ÙŠÙ…</button>
                    <button class="control-btn" id="undoBtn">â†©ï¸</button>
                    <button class="control-btn" id="redoBtn">â†ªï¸</button>
                    <button class="control-btn" id="cmFindBtn">ğŸ” Ø¨Ø­Ø«</button>
                    <button class="control-btn" id="cmReplaceBtn">ğŸ”„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
                    <button class="control-btn" id="toggleDialogueBtn">ğŸ¨ Ø­ÙˆØ§Ø±</button>
                </div>
            </div>

            <div class="control-row">
                <button class="control-btn save" id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
            </div>
        </div>

        <textarea class="text-editor theme-white" id="textEditor" placeholder="Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù‡Ù†Ø§..." style="display: none;"></textarea>

        <div class="stats" id="stats">ğŸ“ 0 ÙƒÙ„Ù…Ø© | ğŸ“ 0 Ø³Ø·Ø±</div>
    </div>

    <button class="exit-btn" id="exitBtn">âŒ</button>

    <div class="modal" id="fileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÙØªØ­ ÙØµÙ„</h2>
                <button class="close-modal" id="closeFileModalBtn">Ã—</button>
            </div>
            
            <div class="input-group">
                <div class="segmented-control" id="dbTypeControl">
                    <button class="segment active" data-db="english">ğŸ“– ÙØµÙˆÙ„ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</button>
                    <button class="segment" data-db="translated">âœ… ÙØµÙˆÙ„ Ù…ØªØ±Ø¬Ù…Ø©</button>
                </div>
            </div>
            <div class="input-group">
                <input type="text" id="fileSearchInput" class="search-bar" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙØµÙ„...">
            </div>

            <div class="modal-controls">
                <button class="modal-btn select" id="selectFilesBtn">ØªØ­Ø¯ÙŠØ¯</button>
                
                <button class="modal-btn" id="selectAllFilesBtn" style="display: none; background: #007bff; color: white; flex-grow: 1;">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                <button class="modal-btn" id="deselectAllFilesBtn" style="display: none; background: #6c757d; color: white; flex-grow: 1;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
                <button class="modal-btn" id="reverseSortBtn" title="Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨">ğŸ”ƒ</button>
                <button class="modal-btn danger" id="deleteFilesBtn" style="display: none;">Ø­Ø°Ù</button>
            </div>

            <div class="sort-control">
                <div class="segmented-control" id="sortControl">
                    <button class="segment active" data-sort="modified">Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="segment" data-sort="alphabetical">Ø£Ø¨Ø¬Ø¯ÙŠ</button>
                    <button class="segment" data-sort="numerical">Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„</button>
                </div>
            </div>
            
            <ul class="file-list" id="fileList">
               </ul>
        </div>
    </div>

    <div class="modal" id="colorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ø§Ø®ØªØ± Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h2>
                <button class="close-modal" id="closeColorModalBtn">Ã—</button>
            </div>
            <div class="color-list" id="colorList"></div>
        </div>
    </div>

    <div class="modal" id="findReplaceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ø¨Ø­Ø« ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„</h2>
                <button class="close-modal" id="closeFindReplaceModalBtn">Ã—</button>
            </div>
            <div class="input-group">
                <label>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Øµ:</label>
                <input type="text" id="findText" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡">
            </div>
            <div class="input-group">
                <label>Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù€:</label>
                <input type="text" id="replaceText" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¨Ø¯ÙŠÙ„">
            </div>
            <button class="control-btn save" id="performFindReplaceBtn" style="width: 100%;">âœ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒÙ„</button>
        </div>
    </div>
    <div class="modal" id="importTypeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª</h2>
                <button class="close-modal" id="closeImportTypeModalBtn">Ã—</button>
            </div>
            <p style="margin-bottom: 20px; color: #6c757d;">Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„ÙØµÙˆÙ„ØŸ</p>
            <div class="import-options">
                <button class="import-btn" id="importEnglishBtn">ğŸ“– Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ€ "ÙØµÙˆÙ„ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©" (Ù„Ù„Ù…ØªØ±Ø¬Ù…)</button>
                <button class="import-btn" id="importTranslatedBtn">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ€ "ÙØµÙˆÙ„ Ù…ØªØ±Ø¬Ù…Ø©" (Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="exportZipModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ØªØµØ¯ÙŠØ± Ø§Ù„ÙØµÙˆÙ„ ÙƒÙ€ ZIP</h2>
                <button class="close-modal" id="closeExportZipModalBtn">Ã—</button>
            </div>
            <p style="margin-bottom: 20px; color: #6c757d;">Ø£ÙŠ Ø§Ù„ÙØµÙˆÙ„ ØªØ±ÙŠØ¯ ØªØµØ¯ÙŠØ±Ù‡Ø§ØŸ</p>
            <div class="import-options"> <button class="import-btn" id="exportEnglishZipBtn">ğŸ“– ØªØµØ¯ÙŠØ± Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</button>
                <button class="import-btn" id="exportTranslatedZipBtn">âœ… ØªØµØ¯ÙŠØ± Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø©</button>
            </div>
        </div>
    </div>

    <div class="modal" id="fontModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">âœï¸ Ø§Ø®ØªØ± Ø§Ù„Ø®Ø·</h2>
                <button class="close-modal" id="closeFontModalBtn">Ã—</button>
            </div>
            <div class="modal-body">
                <ul id="fontList" class="selection-list">
                    </ul>
            </div>
        </div>
    </div>

    <div class="modal" id="themeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ¨ Ø§Ø®ØªØ± Ø§Ù„Ø«ÙŠÙ…</h2>
                <button class="close-modal" id="closeThemeModalBtn">Ã—</button>
            </div>
            <div class="modal-body">
                <ul id="themeList" class="selection-list">
                    </ul>
            </div>
        </div>
    </div>
    <div class="notification" id="notification"></div>

    <script src="config.js"></script>
    <script src="translator_core.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/mode/overlay.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/dialog/dialog.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/search/searchcursor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/search/search.js"></script>
    <script>
        // --- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        const state = {
            selectedFile: null,
            selectedFileDB: 'none', 
            fontSize: 18,
            lineSpacing: 1.5,
            fontName: 'Geeza Pro',
            theme: 'white',
            interfaceColor: 'white',
            readMode: false,
            fullscreen: false,
            fileSortType: 'modified', 
            fileSortReversed: false,
            fileDBType: 'english',
            dialogueHighlighting: false
        };

        // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
        const elements = {
            container: document.getElementById('editorContainer'),
            header: document.getElementById('header'),
            controls: document.getElementById('controls'),
            textEditor: document.getElementById('textEditor'),
            stats: document.getElementById('stats'),
            exitBtn: document.getElementById('exitBtn'),
            filenameInput: document.getElementById('filenameInput'),
            // === ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø¬Ù„Ø¨ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ===
            newChapterBtn: document.getElementById('newChapterBtn'),
            // ===================================
            
            // ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø¹Ù†Ø§ØµØ± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ====
            prevChapterBtn: document.getElementById('prevChapterBtn'),
            nextChapterBtn: document.getElementById('nextChapterBtn'),
            // ======================================

            fileModal: document.getElementById('fileModal'),
            colorModal: document.getElementById('colorModal'),
            findReplaceModal: document.getElementById('findReplaceModal'), 
            
            importTypeModal: document.getElementById('importTypeModal'),
            closeImportTypeModalBtn: document.getElementById('closeImportTypeModalBtn'),
            importEnglishBtn: document.getElementById('importEnglishBtn'),
            importTranslatedBtn: document.getElementById('importTranslatedBtn'),
            
            exportZipModal: document.getElementById('exportZipModal'),
            closeExportZipModalBtn: document.getElementById('closeExportZipModalBtn'),
            exportEnglishZipBtn: document.getElementById('exportEnglishZipBtn'),
            exportTranslatedZipBtn: document.getElementById('exportTranslatedZipBtn'),

            dbTypeControl: document.getElementById('dbTypeControl'), 
            fileSearchInput: document.getElementById('fileSearchInput'),
            selectFilesBtn: document.getElementById('selectFilesBtn'),
            deleteFilesBtn: document.getElementById('deleteFilesBtn'),
            reverseSortBtn: document.getElementById('reverseSortBtn'),
            sortControl: document.getElementById('sortControl'),
            fileList: document.getElementById('fileList'),
            
            selectAllFilesBtn: document.getElementById('selectAllFilesBtn'),
            deselectAllFilesBtn: document.getElementById('deselectAllFilesBtn'),
            toggleDialogueBtn: document.getElementById('toggleDialogueBtn'),

            // ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ====
            fontSelectBtn: document.getElementById('fontSelectBtn'),
            themeSelectBtn: document.getElementById('themeSelectBtn'),
            fontModal: document.getElementById('fontModal'),
            themeModal: document.getElementById('themeModal'),
            fontList: document.getElementById('fontList'),
            themeList: document.getElementById('themeList'),
            closeFontModalBtn: document.getElementById('closeFontModalBtn'),
            closeThemeModalBtn: document.getElementById('closeThemeModalBtn')
            // ======================================
        };
        
        let cmEditor;
        let autoSaveTimer = null;

        // --- Ø­Ø§Ù„Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„ÙØ§Øª (Ù„Ù„ØªØ­Ø¯ÙŠØ¯) ---
        let fileModalSelectMode = false;
        let fileModalSelectedFiles = new Set();
        let pendingImportFiles = null;


        // --- ØªØ­Ù…ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ---

        // ==== ğŸ’¡ (ØªØ¹Ø¯ÙŠÙ„) Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© loadConfig ====
        function loadConfig() {
            const config = localStorage.getItem('zeusEditorConfig');
            if (config) {
                const parsed = JSON.parse(config);
                state.fontSize = parsed.fontSize || 18;
                state.lineSpacing = parsed.lineSpacing || 1.5;
                state.fontName = parsed.fontName || 'Geeza Pro';
                state.theme = parsed.theme || 'white';
                state.interfaceColor = parsed.interfaceColor || 'white';
                state.selectedFile = parsed.lastOpenedFile || null;
                state.selectedFileDB = parsed.lastOpenedFileDB || 'none'; 
                state.fileSortType = parsed.fileSortType || 'modified';
                state.fileSortReversed = parsed.fileSortReversed || false;
                state.fileDBType = parsed.fileDBType || 'english';
                
                // (ØªÙ… Ø§Ù„Ø­Ø°Ù) Ù„Ù† Ù†Ø·Ø¨Ù‚Ù‡Ø§ Ù‡Ù†Ø§ØŒ Ø¨Ù„ ÙÙŠ DOMContentLoaded
                
                // (ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡) Ù‡Ø°Ø§ ÙŠØ·Ø¨Ù‚ Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ ÙˆÙ‡Ùˆ Ù„Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ cmEditor
                applyInterfaceColor(state.interfaceColor); 
            }
            
            // (ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡) Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø³ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            if (state.selectedFile && state.selectedFileDB !== 'none') {
                if (typeof readEnglishChapter !== 'undefined' && typeof readTranslatedChapter !== 'undefined') {
                    if (cmEditor) {
                        loadFile(state.selectedFile, state.selectedFileDB);
                    } else {
                         // Ù‡Ø°Ø§ Ø§Ø­ØªÙŠØ§Ø·ÙŠØŒ Ø³ÙŠØ¶Ù…Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© cmEditor
                        document.addEventListener('DOMContentLoaded', () => {
                            loadFile(state.selectedFile, state.selectedFileDB);
                        });
                    }
                } else {
                    console.error("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¯ÙˆØ§Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙØµÙˆÙ„ (translator_core.js)!");
                }
            }
        }
        // ============================================

        function saveConfig() {
            const config = {
                fontSize: state.fontSize,
                lineSpacing: state.lineSpacing,
                fontName: state.fontName,
                theme: state.theme,
                interfaceColor: state.interfaceColor,
                lastOpenedFile: state.selectedFile,
                lastOpenedFileDB: state.selectedFileDB, 
                fileSortType: state.fileSortType,
                fileSortReversed: state.fileSortReversed,
                fileDBType: state.fileDBType
            };
            localStorage.setItem('zeusEditorConfig', JSON.stringify(config));
        }

        
        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ---
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // --- Ø¯ÙˆØ§Ù„ Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©) ---

        function setupEventListeners() {
            document.getElementById('openChapterBtn').addEventListener('click', openFileModal);
            // === ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ===
            document.getElementById('newChapterBtn').addEventListener('click', createNewChapter);
            // ===================================
            
            // ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) ØªØ´ØºÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ====
            elements.prevChapterBtn.addEventListener('click', () => navigateChapter('prev'));
            elements.nextChapterBtn.addEventListener('click', () => navigateChapter('next'));
            // ======================================

            document.getElementById('importFileBtn').addEventListener('click', onImportClick); 
            document.getElementById('exportZipBtn').addEventListener('click', openExportZipModal); 
            document.getElementById('bgColorBtn').addEventListener('click', openColorModal);
            document.getElementById('readBtn').addEventListener('click', toggleReadMode);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('exitBtn').addEventListener('click', exitSpecialMode);
            document.getElementById('saveBtn').addEventListener('click', () => saveChanges(false)); // ğŸ’¡ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙŠØ¯ÙˆÙŠ
            document.getElementById('increaseFontBtn').addEventListener('click', increaseFont);
            document.getElementById('decreaseFontBtn').addEventListener('click', decreaseFont);
            document.getElementById('spacingBtn').addEventListener('click', toggleSpacing);
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
            
            // ==== ğŸ’¡ (ØªØ¹Ø¯ÙŠÙ„) Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ù„ÙŠØµØ¨Ø­ Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ (ÙŠÙØªØ­/ÙŠØºÙ„Ù‚) ====
            document.getElementById('cmFindBtn').addEventListener('click', () => {
                const editorWrapper = cmEditor.getWrapperElement();
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ø­ÙˆØ§Ø± Ù…ÙØªÙˆØ­Ø©
                const dialogOpen = editorWrapper.querySelector('.CodeMirror-dialog');

                if (dialogOpen) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©ØŒ Ø£ØºÙ„Ù‚Ù‡Ø§
                    cmEditor.execCommand("clearSearch");
                } else {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØºÙ„Ù‚Ø©ØŒ Ø§ÙØªØ­Ù‡Ø§
                    cmEditor.execCommand("find"); 
                }
            });
            
            // (Ø¥Ø¶Ø§ÙØ©) Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            document.getElementById('cmReplaceBtn').addEventListener('click', openFindReplaceModal); 
            
            document.getElementById('toggleDialogueBtn').addEventListener('click', toggleDialogueHighlighting);
            
            // (Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ©) Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
            document.getElementById('closeFindReplaceModalBtn').addEventListener('click', closeFindReplaceModal);
            document.getElementById('performFindReplaceBtn').addEventListener('click', performFindReplace);
            // ==================================================

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ°
            document.getElementById('closeFileModalBtn').addEventListener('click', closeFileModal);
            document.getElementById('closeColorModalBtn').addEventListener('click', closeColorModal);
            
            elements.closeImportTypeModalBtn.addEventListener('click', () => elements.importTypeModal.classList.remove('show'));
            elements.importEnglishBtn.addEventListener('click', () => startImportProcess('english'));
            elements.importTranslatedBtn.addEventListener('click', () => startImportProcess('translated'));

            elements.closeExportZipModalBtn.addEventListener('click', () => elements.exportZipModal.classList.remove('show'));
            elements.exportEnglishZipBtn.addEventListener('click', () => startZipExport('english'));
            elements.exportTranslatedZipBtn.addEventListener('click', () => startZipExport('translated'));

            // ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ====
            elements.fontSelectBtn.addEventListener('click', openFontModal);
            elements.themeSelectBtn.addEventListener('click', openThemeModal);
            elements.closeFontModalBtn.addEventListener('click', closeFontModal);
            elements.closeThemeModalBtn.addEventListener('click', closeThemeModal);
            // ====================================================

            elements.filenameInput.addEventListener('change', renameFile);
            elements.filenameInput.addEventListener('blur', renameFile);
            
            elements.dbTypeControl.addEventListener('click', (e) => {
                 if (e.target.classList.contains('segment')) {
                     const selectedDB = e.target.dataset.db; 
                     document.querySelectorAll('#dbTypeControl .segment').forEach(s => s.classList.remove('active'));
                     e.target.classList.add('active');
                     state.fileDBType = selectedDB;
                     saveConfig(); 
                     updateFileListView(); 
                 }
            });
            
            elements.fileSearchInput.addEventListener('input', updateFileListView);
            elements.sortControl.addEventListener('click', (e) => {
                 if (e.target.classList.contains('segment')) {
                     document.querySelectorAll('#sortControl .segment').forEach(s => s.classList.remove('active'));
                     e.target.classList.add('active');
                     state.fileSortType = e.target.dataset.sort;
                     saveConfig();
                     updateFileListView(); 
                 }
            });
            elements.reverseSortBtn.addEventListener('click', () => {
                state.fileSortReversed = !state.fileSortReversed; 
                elements.reverseSortBtn.classList.toggle('active', state.fileSortReversed); 
                saveConfig(); 
                updateFileListView(); 
            });
            elements.selectFilesBtn.addEventListener('click', toggleSelectMode);
            elements.deleteFilesBtn.addEventListener('click', deleteSelectedFiles);
            
            elements.selectAllFilesBtn.addEventListener('click', selectAllFiles);
            elements.deselectAllFilesBtn.addEventListener('click', deselectAllFiles);

            // ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ù„ØªÙ†Ù‚Ù„ ====
            document.addEventListener('keydown', function(event) {
                const key = event.key; 
                
                // Ø§Ù„Ø³Ù‡Ù… Ø§Ù„ÙŠØ³Ø§Ø± (Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
                if (key === 'ArrowLeft') {
                    // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ø³Ù‡Ù… ÙÙ‚Ø· ÙŠÙƒÙÙŠ
                    // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©: ÙŠØ¬Ø¨ Ø¶ØºØ· Alt Ù„ØªØ¬Ù†Ø¨ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø¤Ø´Ø±
                    if (state.readMode || event.altKey) {
                        event.preventDefault(); 
                        navigateChapter('next');
                    }
                } 
                // Ø§Ù„Ø³Ù‡Ù… Ø§Ù„ÙŠÙ…ÙŠÙ† (Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
                else if (key === 'ArrowRight') {
                    if (state.readMode || event.altKey) {
                        event.preventDefault();
                        navigateChapter('prev');
                    }
                }
            });
            // ========================================================
        }

        // ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ÙØµÙˆÙ„ ====
        function navigateChapter(direction) {
            // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù Ù…ÙØªÙˆØ­ ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®ØªØ§Ø±Ø©
            if (!state.selectedFile || state.selectedFileDB === 'none') {
                showNotification('âš ï¸ ÙŠØ¬Ø¨ ÙØªØ­ ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªÙ†Ù‚Ù„.', 'warning');
                return;
            }

            // 2. Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø£Ùˆ Ù…ØªØ±Ø¬Ù…)
            const dbKey = (state.selectedFileDB === 'english') ? CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS : CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS;
            const files = Storage.get(dbKey, {});
            const fileNames = Object.keys(files);

            if (fileNames.length <= 1) {
                showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ Ø£Ø®Ø±Ù‰ Ù„Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„ÙŠÙ‡Ø§.', 'warning');
                return;
            }

            // 3. ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù„ÙØ§Øª "Ø·Ø¨ÙŠØ¹ÙŠØ§Ù‹" (Ø­ÙŠØ« ÙŠØ£ØªÙŠ 2 Ø¨Ø¹Ø¯ 1ØŒ Ùˆ 10 Ø¨Ø¹Ø¯ 9)
            fileNames.sort((a, b) => {
                return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
            });

            // 4. Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
            const currentIndex = fileNames.indexOf(state.selectedFile);
            if (currentIndex === -1) return; 

            // 5. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‡Ø¯Ù
            let targetFile = null;
            if (direction === 'next') {
                if (currentIndex < fileNames.length - 1) {
                    targetFile = fileNames[currentIndex + 1];
                } else {
                    showNotification('ğŸš« Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£Ø®ÙŠØ±.', 'warning');
                }
            } else if (direction === 'prev') {
                if (currentIndex > 0) {
                    targetFile = fileNames[currentIndex - 1];
                } else {
                    showNotification('ğŸš« Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„.', 'warning');
                }
            }

            // 6. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ø°Ø§ ÙˆØ¬Ø¯
            if (targetFile) {
                // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                saveChanges(true); 
                loadFile(targetFile, state.selectedFileDB);
            }
        }
        // ============================================

        // --- Ø¯ÙˆØ§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ ---

        function applyTheme(theme) {
            if (cmEditor) {
                const cmWrapper = cmEditor.getWrapperElement();
                cmWrapper.classList.remove('theme-white', 'theme-dark', 'theme-blue-dark');
                cmWrapper.classList.add(`theme-${theme}`);
                elements.textEditor.classList.remove('theme-white', 'theme-dark', 'theme-blue-dark');
                elements.textEditor.classList.add(`theme-${theme}`);
            }
            state.theme = theme;
            saveConfig();
        }

        function applyFont(fontName) {
            if (cmEditor) {
                cmEditor.getWrapperElement().style.fontFamily = fontName;
                cmEditor.refresh(); 
            }
            state.fontName = fontName;
            saveConfig();
        }

        function applyFontSize(size) {
            if (cmEditor) {
                cmEditor.getWrapperElement().style.fontSize = `${size}px`;
                cmEditor.refresh();
            }
            state.fontSize = size;
            saveConfig();
        }

        function applyLineSpacing(spacing) {
            if (cmEditor) {
                cmEditor.getWrapperElement().style.lineHeight = spacing;
                cmEditor.refresh();
            }
            state.lineSpacing = spacing;
            saveConfig();
        }

        function increaseFont() {
            applyFontSize(state.fontSize + 1);
        }

        function decreaseFont() {
            if (state.fontSize > 8) {
                applyFontSize(state.fontSize - 1);
            }
        }

        function toggleSpacing() {
            let newSpacing = state.lineSpacing;
            if (state.lineSpacing === 1.5) newSpacing = 2.0;
            else if (state.lineSpacing === 2.0) newSpacing = 1.0;
            else newSpacing = 1.5;
            applyLineSpacing(newSpacing);
            showNotification(`ØªÙ… Ø¶Ø¨Ø· Ø§Ù„ØªØ¨Ø§Ø¹Ø¯ Ø¥Ù„Ù‰ ${newSpacing}`, 'warning');
        }

        function undo() {
            if (cmEditor) cmEditor.undo();
        }

        function redo() {
            if (cmEditor) cmEditor.redo();
        }

        function updateStats() {
            if (!cmEditor) return; 
            const text = cmEditor.getValue();
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
            const lineCount = cmEditor.lineCount(); 
            elements.stats.textContent = `ğŸ“ ${wordCount} ÙƒÙ„Ù…Ø© | ğŸ“ ${lineCount} Ø³Ø·Ø±`;
        }
        
        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ„ÙˆÙŠÙ† ---
        const systemTextOverlay = {
            token: function(stream) {
                if (stream.match(/\[.*?\]/)) { return "system-text"; }
                while (stream.next() != null && !stream.match(/\[.*?\]/, false)) {}
                return null;
            }
        };

        const dialogueOverlay = {
            token: function(stream) {
                let ch;
                if (stream.peek() === '"') {
                    stream.next();
                    while ((ch = stream.next()) != null) { if (ch === '"') break; }
                    return "dialogue-text";
                }
                if (stream.peek() === "'") {
                    stream.next();
                    while ((ch = stream.next()) != null) { if (ch === "'") break; }
                    return "dialogue-text";
                }
                stream.next();
                return null;
            }
        };

        function toggleDialogueHighlighting() {
            if (!cmEditor) return;
            state.dialogueHighlighting = !state.dialogueHighlighting; 
            if (state.dialogueHighlighting) {
                cmEditor.addOverlay(dialogueOverlay);
                elements.toggleDialogueBtn.classList.add('active'); 
                showNotification('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª', 'success');
            } else {
                cmEditor.removeOverlay(dialogueOverlay);
                elements.toggleDialogueBtn.classList.remove('active'); 
                showNotification('âšªï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª', 'warning');
            }
        }
        
        // --- Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ---
        function onImportClick() {
            if (typeof saveEnglishChapter === 'undefined' || typeof saveTranslatedChapter === 'undefined') {
                showNotification('Ø®Ø·Ø£: Ù…Ù„Ù translator_core.js ØºÙŠØ± Ù…Ø­Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.', 'error');
                return;
            }
            elements.importTypeModal.classList.toggle('dark-interface', state.interfaceColor === 'black');
            elements.importTypeModal.classList.add('show');
        }
        
        function startImportProcess(importType) {
            elements.importTypeModal.classList.remove('show');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.zip'; 
            input.multiple = true; 
            input.click(); 
            input.onchange = (e) => {
                const files = e.target.files;
                if (files.length === 0) return;
                processImportedFiles(files, importType);
            };
        }

        async function processImportedFiles(files, dbType) {
            if (typeof JSZip === 'undefined') {
                showNotification('Ø®Ø·Ø£: Ù…ÙƒØªØ¨Ø© (JSZip) ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.', 'error');
                return;
            }
            const dbName = dbType === 'english' ? 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' : 'Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø©';
            let importedFileNames = [];
            showNotification(`Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${files.length} Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ "${dbName}"...`, 'warning');
            const saveFunction = (dbType === 'english') ? saveEnglishChapter : saveTranslatedChapter;
            for (const file of files) {
                const fileNameLower = file.name.toLowerCase();
                if (fileNameLower.endsWith('.zip')) {
                    try {
                        const zip = await JSZip.loadAsync(file); 
                        const txtFilesEntries = [];
                        zip.forEach((relativePath, zipEntry) => {
                            if (zipEntry.name.toLowerCase().endsWith('.txt') && !zipEntry.dir) {
                                txtFilesEntries.push(zipEntry);
                            }
                        });
                        if (txtFilesEntries.length === 0) {
                            showNotification(`Ù…Ù„Ù ZIP ${file.name} Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª .txt`, 'warning');
                            continue;
                        }
                        for (const zipEntry of txtFilesEntries) {
                            const content = await zipEntry.async('string');
                            const filename = zipEntry.name.split('/').pop(); 
                            saveFunction(filename, content);
                            importedFileNames.push(filename);
                        }
                    } catch (err) {
                        showNotification(`ÙØ´Ù„ ÙÙŠ ÙÙƒ Ø¶ØºØ· ${file.name}`, 'error');
                        console.error(err);
                    }
                } else if (fileNameLower.endsWith('.txt')) {
                    try {
                        const content = await file.text(); 
                        const filename = file.name;
                        saveFunction(filename, content);
                        importedFileNames.push(filename);
                    } catch (err) {
                         showNotification(`ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ${file.name}`, 'error');
                         console.error(err);
                    }
                } else {
                    showNotification(`ØªÙ… ØªØ®Ø·ÙŠ ${file.name} (Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…)`, 'warning');
                }
            }
            if (importedFileNames.length > 0) {
                loadFile(importedFileNames[importedFileNames.length - 1], dbType); 
                showNotification(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedFileNames.length} ÙØµÙˆÙ„ Ø¥Ù„Ù‰ "${dbName}"!`);
            } else {
                 showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ù…Ù„ÙØ§Øª .txt Ø¬Ø¯ÙŠØ¯Ø©', 'warning');
            }
        }

        function renameFile() {
            if (!state.selectedFile || state.selectedFileDB === 'none') {
                showNotification('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…ÙØªÙˆØ­ Ù„ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ù‡', 'error');
                elements.filenameInput.disabled = true;
                elements.filenameInput.value = '';
                return;
            }
            const oldName = state.selectedFile;
            let newName = elements.filenameInput.value.trim();
            if (!newName) {
                showNotification('âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹', 'error');
                elements.filenameInput.value = oldName;
                return;
            }
            if (!newName.toLowerCase().endsWith('.txt')) {
                newName += '.txt';
                elements.filenameInput.value = newName;
            }
            if (newName === oldName) return;
            const dbKey = (state.selectedFileDB === 'english') ? CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS : CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS;
            const files = Storage.get(dbKey, {});
            if (files[newName]) {
                showNotification(`âŒ Ù…Ù„Ù Ø¨Ø§Ù„Ø§Ø³Ù… '${newName}' Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©`, 'error');
                elements.filenameInput.value = oldName;
                return;
            }
            files[newName] = files[oldName]; 
            files[newName].modified = Date.now();
            delete files[oldName]; 
            state.selectedFile = newName;
            Storage.set(dbKey, files); 
            saveConfig();
            showNotification(`âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰\n${newName}`);
        }

        function saveChanges(isAutoSave = false) {
            let filename = state.selectedFile;
            let dbType = state.selectedFileDB;
            if (!filename || dbType === 'none') {
                if (isAutoSave) return; 
                showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…ÙØªÙˆØ­. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ø¹Ø¨Ø± Ø§Ù„Ø­ÙØ¸.', 'warning');
                filename = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„: chapter1.txt):");
                if (!filename) {
                    showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙØ¸', 'warning');
                    return;
                }
                const saveLocation = prompt("Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŸ Ø§ÙƒØªØ¨ 'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ' Ø£Ùˆ 'Ù…ØªØ±Ø¬Ù…':");
                if (saveLocation && (saveLocation.toLowerCase().includes('Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ') || saveLocation.toLowerCase().includes('english'))) {
                    dbType = 'english';
                } else if (saveLocation && (saveLocation.toLowerCase().includes('Ù…ØªØ±Ø¬Ù…') || saveLocation.toLowerCase().includes('translated'))) {
                    dbType = 'translated';
                } else {
                    showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙØ¸. ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.', 'warning');
                    return;
                }
                if (!filename.toLowerCase().endsWith('.txt')) {
                    filename += '.txt';
                }
            }
            if (typeof saveEnglishChapter === 'undefined' || typeof readEnglishChapter === 'undefined') {
                showNotification('Ø®Ø·Ø£: Ù…Ù„Ù translator_core.js ØºÙŠØ± Ù…Ø­Ù…Ù„!', 'error');
                return;
            }
            const contentToSave = cmEditor.getValue();
            const saveFunction = (dbType === 'english') ? saveEnglishChapter : saveTranslatedChapter;
            const readFunction = (dbType === 'english') ? readEnglishChapter : readTranslatedChapter;
            
            // ØªØ¹Ø¯ÙŠÙ„ Ø·ÙÙŠÙ: Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† `files` Ù…Ø¨Ø§Ø´Ø±Ø©
            const dbKey = (dbType === 'english') ? CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS : CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS;
            const files = Storage.get(dbKey, {});
            const currentContentInDB = (files[filename]) ? files[filename].content : null;

            if (currentContentInDB !== null && currentContentInDB === contentToSave) {
                 if (!isAutoSave) {
                     showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§', 'warning');
                 }
                 return;
            }
            saveFunction(filename, contentToSave);
            state.selectedFile = filename;
            state.selectedFileDB = dbType; 
            elements.filenameInput.value = filename;
            elements.filenameInput.disabled = false;
            saveConfig();
            if (!isAutoSave) {
                showNotification(`âœ… ØªÙ… Ø­ÙØ¸ ${filename} Ø¨Ù†Ø¬Ø§Ø­`);
            }
        }

        // --- ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙØµÙ„ Ø¬Ø¯ÙŠØ¯ ---
        function createNewChapter() {
            // 1. Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
            let filename = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„: chapter1.txt):");
            if (!filename) {
                showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', 'warning');
                return;
            }

            // 2. Ø·Ù„Ø¨ Ù…ÙƒØ§Ù† Ø§Ù„Ø­ÙØ¸
            const saveLocation = prompt("Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŸ Ø§ÙƒØªØ¨ 'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ' Ø£Ùˆ 'Ù…ØªØ±Ø¬Ù…':");
            let dbType;
            if (saveLocation && (saveLocation.toLowerCase().includes('Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ') || saveLocation.toLowerCase().includes('english'))) {
                dbType = 'english';
            } else if (saveLocation && (saveLocation.toLowerCase().includes('Ù…ØªØ±Ø¬Ù…') || saveLocation.toLowerCase().includes('translated'))) {
                dbType = 'translated';
            } else {
                showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡. ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.', 'warning');
                return;
            }

            // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù…ØªØ¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù
            if (!filename.toLowerCase().endsWith('.txt')) {
                filename += '.txt';
            }

            // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹ (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©)
            const dbKey = (dbType === 'english') ? CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS : CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS;
            const files = Storage.get(dbKey, {});
            if (files[filename]) {
                showNotification(`âŒ Ù…Ù„Ù Ø¨Ø§Ù„Ø§Ø³Ù… '${filename}' Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.`, 'error');
                return;
            }

            // 5. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù (ÙØ§Ø±Øº)
            const saveFunction = (dbType === 'english') ? saveEnglishChapter : saveTranslatedChapter;
            saveFunction(filename, ""); // Ø­ÙØ¸ Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº

            // 6. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø±
            loadFile(filename, dbType);
            showNotification(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${filename} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }

        function loadFile(filename, dbType) {
            if (!cmEditor) {
                showNotification('Ø®Ø·Ø£: Ø§Ù„Ù…Ø­Ø±Ø± ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„', 'error');
                return;
            }
            // ğŸ’¡ ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            const dbKey = (dbType === 'english') ? CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS : CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS;
            const files = Storage.get(dbKey, {});
            
            if (files[filename] !== undefined) {
                const fileContent = files[filename].content || ""; // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø£Ùˆ Ø³Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹)
                cmEditor.setValue(fileContent);
                state.selectedFile = filename;
                state.selectedFileDB = dbType; 
                elements.filenameInput.value = filename;
                elements.filenameInput.disabled = false;
                cmEditor.clearHistory();
                updateStats();
                saveConfig();
                if (fileContent === "") {
                    showNotification(`ğŸ“„ ØªÙ… ÙØªØ­ ${filename} (Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯)`);
                } else {
                    showNotification(`ğŸ“– ØªÙ… ÙØªØ­ ${filename}`);
                }
                cmEditor.scrollTo(0, 0); 
                cmEditor.setCursor(0, 0); 
            } else {
                showNotification(`Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù ${filename}`, 'error');
            }
        }


        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) ---
        
        function openFileModal() {
            if (typeof listEnglishChapters === 'undefined' || typeof listTranslatedChapters === 'undefined') {
                showNotification('Ø®Ø·Ø£: Ù…Ù„Ù translator_core.js ØºÙŠØ± Ù…Ø­Ù…Ù„!', 'error');
                return;
            }
            fileModalSelectMode = false;
            fileModalSelectedFiles.clear();
            elements.fileSearchInput.value = '';
            elements.selectFilesBtn.textContent = 'ØªØ­Ø¯ÙŠØ¯';
            elements.deleteFilesBtn.style.display = 'none';
            elements.fileList.classList.remove('selection-active');
            document.querySelectorAll('#dbTypeControl .segment').forEach(s => {
                s.classList.toggle('active', s.dataset.db === state.fileDBType);
            });
            elements.sortControl.querySelectorAll('.segment').forEach(s => {
                s.classList.toggle('active', s.dataset.sort === state.fileSortType);
            });
            elements.reverseSortBtn.classList.toggle('active', state.fileSortReversed);
            updateFileListView(); 
            elements.fileModal.classList.add('show');
        }

        function closeFileModal() {
            elements.fileModal.classList.remove('show');
        }
        
        function updateFileListView() {
            const searchTerm = elements.fileSearchInput.value.toLowerCase();
            const sortType = state.fileSortType; 
            const activeDBType = elements.dbTypeControl.querySelector('.segment.active').dataset.db;
            const listFunction = (activeDBType === 'english') ? listEnglishChapters : listTranslatedChapters;
            const files = Storage.get( (activeDBType === 'english') ? CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS : CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS, {});
            const fileArray = Object.entries(files).map(([name, data]) => ({
                name,
                ...data,
                content: data.content || "" 
            }));
            const dbName = (activeDBType === 'english') ? "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©" : "Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø©";
            if (fileArray.length === 0) {
                 elements.fileList.innerHTML = `<li style="padding: 20px; text-align: center; color: #999;">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ ÙÙŠ "${dbName}".</li>`;
                 return;
            }
            const filteredArray = fileArray.filter(f => f.name.toLowerCase().includes(searchTerm));
            sortFiles(filteredArray, sortType);
            renderFileList(filteredArray, activeDBType); 
        }

        function sortFiles(fileArray, sortType) {
            const getFileNumber = (name) => {
                const match = name.match(/(\d+)/); 
                return match ? parseInt(match[0], 10) : 0; 
            };
            if (sortType === 'modified') {
                fileArray.sort((a, b) => b.modified - a.modified);
            } else if (sortType === 'alphabetical') {
                fileArray.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (sortType === 'numerical') {
                fileArray.sort((a, b) => getFileNumber(a.name) - getFileNumber(b.name));
            }
            if (state.fileSortReversed) {
                fileArray.reverse();
            }
        }

        function renderFileList(fileArray, dbType) { 
            elements.fileList.innerHTML = ''; 
            if (fileArray.length === 0) {
                 elements.fileList.innerHTML = '<li style="padding: 20px; text-align: center; color: #999;">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.</li>';
                 return;
            }
            fileArray.forEach(file => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.dataset.filename = file.name; 
                const sizeKB = (file.content.length / 1024).toFixed(2);
                // const modifiedDate = new Date(file.modified).toLocaleString('ar-SA'); // <-- Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
                const modifiedDate = formatFileDate(file.modified); // <-- ğŸ’¡ (ØªØ¹Ø¯ÙŠÙ„) Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const isChecked = fileModalSelectedFiles.has(file.name);
                if (isChecked) {
                    li.classList.add('selected');
                }
                li.innerHTML = `
                    <div class="file-checkbox-container">
                        <input type="checkbox" class="file-checkbox" ${isChecked ? 'checked' : ''}>
                    </div>
                    <div class="file-details">
                        <div>${file.name}</div>
                        <div class="file-info">${sizeKB} KB | ${modifiedDate}</div>
                    </div>
                `;
                li.addEventListener('click', (e) => {
                    const filename = li.dataset.filename;
                    if (fileModalSelectMode) {
                        const checkbox = li.querySelector('.file-checkbox');
                        if (fileModalSelectedFiles.has(filename)) {
                            fileModalSelectedFiles.delete(filename);
                            li.classList.remove('selected');
                            checkbox.checked = false;
                        } else {
                            fileModalSelectedFiles.add(filename);
                            li.classList.add('selected');
                            checkbox.checked = true;
                        }
                        elements.deleteFilesBtn.textContent = `Ø­Ø°Ù (${fileModalSelectedFiles.size})`;
                    } else {
                        loadFile(filename, dbType);
                        closeFileModal();
                    }
                });
                elements.fileList.appendChild(li);
            });
        }
        
        function toggleSelectMode() {
            fileModalSelectMode = !fileModalSelectMode;
            elements.fileList.classList.toggle('selection-active', fileModalSelectMode);
            if (fileModalSelectMode) {
                elements.selectFilesBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯';
                elements.deleteFilesBtn.style.display = 'block';
                elements.deleteFilesBtn.textContent = 'Ø­Ø°Ù';
                elements.selectAllFilesBtn.style.display = 'block';
                elements.deselectAllFilesBtn.style.display = 'block';
            } else {
                elements.selectFilesBtn.textContent = 'ØªØ­Ø¯ÙŠØ¯';
                elements.deleteFilesBtn.style.display = 'none';
                elements.selectAllFilesBtn.style.display = 'none';
                elements.deselectAllFilesBtn.style.display = 'none';
                fileModalSelectedFiles.clear(); 
                updateFileListView(); 
            }
        }
        
        function deleteSelectedFiles() {
            if (fileModalSelectedFiles.size === 0) {
                showNotification('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ù…Ù„ÙØ§Øª Ù„Ù„Ø­Ø°Ù', 'warning');
                return;
            }
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${fileModalSelectedFiles.size} Ù…Ù„ÙØ§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
                return;
            }
            const activeDBType = elements.dbTypeControl.querySelector('.segment.active').dataset.db;
            const dbKey = (activeDBType === 'english') ? CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS : CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS;
            const files = Storage.get(dbKey, {});
            let fileWasReset = false;
            for (const filename of fileModalSelectedFiles) {
                delete files[filename]; 
                if (state.selectedFile === filename && state.selectedFileDB === activeDBType) {
                    fileWasReset = true;
                }
            }
            if (fileWasReset) {
                state.selectedFile = null;
                state.selectedFileDB = 'none'; 
                elements.filenameInput.value = 'Ù„Ù… ÙŠØªÙ… ÙØªØ­ Ù…Ù„Ù';
                elements.filenameInput.placeholder = 'Ù„Ù… ÙŠØªÙ… ÙØªØ­ Ù…Ù„Ù';
                elements.filenameInput.disabled = true;
                cmEditor.setValue('');
                updateStats();
                saveConfig();
            }
            Storage.set(dbKey, files); 
            showNotification(`âœ… ØªÙ… Ø­Ø°Ù ${fileModalSelectedFiles.size} Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­`);
            toggleSelectMode(); 
        }

        function selectAllFiles() {
            if (!fileModalSelectMode) return;
            const fileItems = elements.fileList.querySelectorAll('.file-item');
            if (fileItems.length === 0) {
                showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ Ù„ØªØ­Ø¯ÙŠØ¯Ù‡Ø§', 'warning');
                return;
            }
            fileItems.forEach(li => {
                const filename = li.dataset.filename;
                if (filename && !li.classList.contains('selected')) { 
                    fileModalSelectedFiles.add(filename); 
                    li.classList.add('selected');
                    const checkbox = li.querySelector('.file-checkbox');
                    if (checkbox) checkbox.checked = true;
                }
            });
            elements.deleteFilesBtn.textContent = `Ø­Ø°Ù (${fileModalSelectedFiles.size})`;
        }

        function deselectAllFiles() {
            if (!fileModalSelectMode) return;
            fileModalSelectedFiles.clear(); 
            const fileItems = elements.fileList.querySelectorAll('.file-item');
            fileItems.forEach(li => {
                li.classList.remove('selected');
                const checkbox = li.querySelector('.file-checkbox');
                if (checkbox) checkbox.checked = false;
            });
            elements.deleteFilesBtn.textContent = 'Ø­Ø°Ù (0)';
        }

        // --- ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ---
        function formatFileDate(timestamp) {
            const now = new Date();
            const fileDate = new Date(timestamp);
            const diffMs = now - fileDate;
            const diffHours = diffMs / (1000 * 60 * 60);

            // e.g., "2:16 PM"
            const timeFormat = fileDate.toLocaleString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            }); 

            if (diffHours < 24) {
                // Rule 1: Less than 24 hours ago
                return timeFormat;
            } else {
                // Rule 2: 24 hours or more ago
                const diffDays = Math.floor(diffHours / 24);
                
                // Check if it was *actually* "Yesterday"
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                
                if (yesterday.toDateString() === fileDate.toDateString()) {
                     return `Yesterday at ${timeFormat}`;
                } else {
                    // More than 1 day ago. Just show the date.
                    // e.g., "11/14/2025"
                    return fileDate.toLocaleDateString('en-US');
                }
            }
        }
        // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---
        
        function applyInterfaceColor(value) {
            state.interfaceColor = value;
            const gradient = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            const allModals = document.querySelectorAll('.modal-content');
            
            if (value === 'white') {
                document.body.style.background = gradient;
                elements.header.style.background = gradient;
                elements.controls.classList.remove('dark-interface');
                elements.stats.classList.remove('dark-interface');
                allModals.forEach(modal => modal.classList.remove('dark-interface'));
            } else if (value === 'black') {
                document.body.style.background = value;
                elements.header.style.background = value;
                elements.controls.classList.add('dark-interface');
                elements.stats.classList.add('dark-interface');
                allModals.forEach(modal => modal.classList.add('dark-interface'));
            } else { 
                document.body.style.background = value;
                elements.header.style.background = value;
                elements.controls.classList.remove('dark-interface');
                elements.stats.classList.remove('dark-interface');
                allModals.forEach(modal => modal.classList.remove('dark-interface'));
            }
            saveConfig();
        }

        function openColorModal() {
            const colors = {
                'Ø§ÙØªØ±Ø§Ø¶ÙŠ': 'white',
                'Ø±Ù…Ø§Ø¯ÙŠ': '#DDDDDD',
                'Ø¨ÙŠØ¬': '#F5F5DC',
                'ÙƒØ±ÙŠÙ…ÙŠ': '#FFF8DC',
                'Ø§Ø³ÙˆØ¯': 'black'
            };
            const colorList = document.getElementById('colorList');
            colorList.innerHTML = '';
            Object.entries(colors).forEach(([name, value]) => {
                const div = document.createElement('div');
                div.className = 'color-item';
                div.style.background = value;
                div.style.color = (value === 'black' || value === 'blue') ? 'white' : 'black';
                div.textContent = name;
                div.addEventListener('click', () => {
                    applyInterfaceColor(value); 
                    showNotification(`âœ… ØªÙ… ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ ${name}`);
                    closeColorModal();
                });
                colorList.appendChild(div);
            });
            elements.colorModal.classList.add('show');
        }

        function closeColorModal() {
            elements.colorModal.classList.remove('show');
        }

        function openFindReplaceModal() {
            elements.findReplaceModal.classList.toggle('dark-interface', state.interfaceColor === 'black');
            elements.findReplaceModal.classList.add('show');
            document.getElementById('findText').focus();
        }

        function closeFindReplaceModal() {
            elements.findReplaceModal.classList.remove('show');
        }

        function performFindReplace() {
            const findText = document.getElementById('findText').value;
            const replaceText = document.getElementById('replaceText').value;
            if (!findText) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡', 'error');
                return;
            }
            const currentText = cmEditor.getValue();
            const newText = currentText.replace(new RegExp(findText, 'g'), replaceText);
            if (currentText === newText) {
                 showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ', 'warning');
            } else {
                 cmEditor.setValue(newText);
                 updateStats();
                 showNotification('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                 closeFindReplaceModal();
            }
        }

        // --- Ø¯ÙˆØ§Ù„ ØªØµØ¯ÙŠØ± ZIP ---
        function openExportZipModal() {
            elements.exportZipModal.classList.toggle('dark-interface', state.interfaceColor === 'black');
            elements.exportZipModal.classList.add('show');
        }

        async function startZipExport(dbType) {
            elements.exportZipModal.classList.remove('show'); 
            if (typeof JSZip === 'undefined') {
                showNotification('Ø®Ø·Ø£: Ù…ÙƒØªØ¨Ø© (JSZip) ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.', 'error');
                return;
            }
            const isEnglish = (dbType === 'english');
            const dbKey = isEnglish ? CONFIG.STORAGE_KEYS.ENGLISH_CHAPTERS : CONFIG.STORAGE_KEYS.TRANSLATED_CHAPTERS;
            const folderName = isEnglish ? 'English_Chapters' : 'Arabic_Chapters';
            const zipFileName = isEnglish ? 'English_Chapters.zip' : 'Arabic_Chapters.zip';
            const dbFriendlyName = isEnglish ? 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©' : 'Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø©';
            showNotification(`Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„ÙØ§Øª ${dbFriendlyName} Ù„Ù„Ø¶ØºØ·...`, 'warning');
            try {
                const files = Storage.get(dbKey, {});
                const fileNames = Object.keys(files);
                if (fileNames.length === 0) {
                    showNotification(`Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ ÙÙŠ "${dbFriendlyName}" Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.`, 'error');
                    return;
                }
                const zip = new JSZip();
                const folder = zip.folder(folderName); 
                for (const filename of fileNames) {
                    const fileData = files[filename];
                    const content = fileData.content || ""; 
                    folder.file(filename, content); 
                }
                showNotification('Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„Ù…Ù„ÙØ§Øª...', 'warning');
                const zipContent = await zip.generateAsync({ 
                    type: "blob",
                    compression: "DEFLATE", 
                    compressionOptions: { level: 9 }
                });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipContent);
                link.download = zipFileName;
                document.body.appendChild(link); 
                link.click(); 
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href); 
                }, 100); 
                showNotification(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${fileNames.length} ÙØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
            } catch (err) {
                console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP:", err);
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP.', 'error');
            }
        }
        
        // --- Ø¯ÙˆØ§Ù„ Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ø¹Ø±Ø¶ ---
        function toggleReadMode() {
            state.readMode = !state.readMode;
            elements.controls.classList.toggle('hidden', state.readMode);
            elements.header.classList.toggle('hidden', state.readMode);
            elements.stats.classList.toggle('hidden', state.readMode);
            elements.exitBtn.classList.toggle('show', state.readMode && !state.fullscreen); 
            if (cmEditor) {
                cmEditor.setOption("readOnly", state.readMode);
                cmEditor.getWrapperElement().classList.toggle('read-only', state.readMode);
            }
        }

        function toggleFullscreen() {
            state.fullscreen = !state.fullscreen;
            elements.header.classList.toggle('hidden', state.fullscreen);
            elements.controls.classList.toggle('hidden', state.fullscreen);
            elements.stats.classList.toggle('hidden', state.fullscreen);
            elements.exitBtn.classList.toggle('show', state.fullscreen); 
            if(state.readMode) {
                 elements.exitBtn.classList.toggle('show', state.fullscreen);
            }
        }

        function exitSpecialMode() {
            if (state.fullscreen) toggleFullscreen(); 
            if (state.readMode) toggleReadMode();
            elements.exitBtn.classList.remove('show');
        }

        // ==== ğŸ’¡ (Ø¥Ø¶Ø§ÙØ©) Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ====
        function openFontModal() {
            const fonts = [
                { name: 'Geeza Pro (Ø§ÙØªØ±Ø§Ø¶ÙŠ)', family: 'Geeza Pro', cssClass: 'font-geeza' },
                { name: 'Cairo (Ø¬Ø¯ÙŠØ¯)', family: "'Cairo', sans-serif", cssClass: 'font-cairo' },
                { name: 'Noto Kufi (Ø¬Ø¯ÙŠØ¯)', family: "'Noto Kufi Arabic', sans-serif", cssClass: 'font-noto-kufi' },
                { name: 'Amiri (Ø¬Ø¯ÙŠØ¯)', family: "'Amiri', serif", cssClass: 'font-amiri' },
                { name: 'Arial', family: 'Arial', cssClass: 'font-arial' },
                { name: 'Times New Roman', family: "'Times New Roman', serif", cssClass: 'font-times' }
            ];
            elements.fontList.innerHTML = ''; // Ø¥ÙØ±Ø§Øº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            fonts.forEach(font => {
                const li = document.createElement('li');
                li.className = `selection-item ${font.cssClass}`;
                li.textContent = font.name;
                if (state.fontName === font.family) {
                    li.classList.add('active');
                }
                li.addEventListener('click', () => {
                    applyFont(font.family);
                    closeFontModal();
                });
                elements.fontList.appendChild(li);
            });
            elements.fontModal.classList.toggle('dark-interface', state.interfaceColor === 'black');
            elements.fontModal.classList.add('show');
        }
        function closeFontModal() {
            elements.fontModal.classList.remove('show');
        }

        function openThemeModal() {
            const themes = [
                { name: 'Ø§Ø¨ÙŠØ¶', value: 'white' },
                { name: 'Ø¯Ø§ÙƒÙ†', value: 'dark' },
                { name: 'Ø§Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ†', value: 'blue-dark' }
            ];
            elements.themeList.innerHTML = ''; // Ø¥ÙØ±Ø§Øº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            themes.forEach(theme => {
                const li = document.createElement('li');
                li.className = 'selection-item';
                li.textContent = theme.name;
                if (state.theme === theme.value) {
                    li.classList.add('active');
                }
                li.addEventListener('click', () => {
                    applyTheme(theme.value);
                    closeThemeModal();
                });
                elements.themeList.appendChild(li);
            });
            elements.themeModal.classList.toggle('dark-interface', state.interfaceColor === 'black');
            elements.themeModal.classList.add('show');
        }
        function closeThemeModal() {
            elements.themeModal.classList.remove('show');
        }
        // ======================================


        // --- Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            
            cmEditor = CodeMirror.fromTextArea(elements.textEditor, {
                lineNumbers: false,
                direction: "rtl",  
                lineWrapping: true, 
                readOnly: state.readMode,
            });

            cmEditor.addOverlay(systemTextOverlay);

            cmEditor.on("change", () => {
                updateStats(); 
                if (autoSaveTimer) clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveChanges(true); 
                }, 2000); 
            });
            
            // ==== ğŸ’¡ (ØªØ¹Ø¯ÙŠÙ„) Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====
            // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ (ÙŠÙ…Ù„Ø£ state)
            loadConfig(); 

            // 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø±Ø±
            applyTheme(state.theme);
            applyFont(state.fontName);
            applyFontSize(state.fontSize);
            applyLineSpacing(state.lineSpacing);

            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ø¥Ø°Ø§ ÙƒØ§Ù† cmEditor Ø¬Ø§Ù‡Ø²Ø§Ù‹)
            if(cmEditor) {
                updateStats();
            }
            // ========================================
        });

    </script>
</body>
</html>
